<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>lsforce.lsforce &mdash; lsforce documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> lsforce
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/lsforce.html">lsforce package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">lsforce</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>lsforce.lsforce</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for lsforce.lsforce</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">random</span> <span class="k">as</span> <span class="nn">rnd</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">which</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlretrieve</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">lines</span> <span class="k">as</span> <span class="n">mlines</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">obspy</span> <span class="kn">import</span> <span class="n">Stream</span><span class="p">,</span> <span class="n">Trace</span><span class="p">,</span> <span class="n">UTCDateTime</span><span class="p">,</span> <span class="n">read</span>
<span class="kn">from</span> <span class="nn">obspy.core</span> <span class="kn">import</span> <span class="n">AttribDict</span>
<span class="kn">from</span> <span class="nn">scipy.signal.windows</span> <span class="kn">import</span> <span class="n">triang</span>

<span class="c1"># Base URL for Syngine queries</span>
<span class="n">SYNGINE_BASE_URL</span> <span class="o">=</span> <span class="s1">&#39;http://service.iris.edu/irisws/syngine/1/query?&#39;</span>

<span class="c1"># [s] Sampling interval for Green&#39;s functions downloaded from Syngine</span>
<span class="n">SYNGINE_DT</span> <span class="o">=</span> <span class="mf">0.25</span>

<span class="c1"># [s] Sampling interval for the triangular source time function given to Syngine</span>
<span class="n">TRIANGLE_STF_DT</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="c1"># A nice constant start time for Syngine and CPS GFs</span>
<span class="n">GF_STARTTIME</span> <span class="o">=</span> <span class="n">UTCDateTime</span><span class="p">(</span><span class="mi">1900</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Convert m/s to μm/s</span>
<span class="n">UMS_PER_MS</span> <span class="o">=</span> <span class="mf">1e6</span>

<span class="c1"># Colors for force components</span>
<span class="n">Z_COLOR</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span>
<span class="n">N_COLOR</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
<span class="n">E_COLOR</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span>

<span class="c1"># Transparency level for jackknife lines and patches</span>
<span class="n">JK_ALPHA</span> <span class="o">=</span> <span class="mf">0.2</span>


<div class="viewcode-block" id="LSForce"><a class="viewcode-back" href="../../api/lsforce.lsforce.html#lsforce.lsforce.LSForce">[docs]</a><span class="k">class</span> <span class="nc">LSForce</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Class for performing force inversions.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        gf_dir (str): Directory containing Green&#39;s functions</span>
<span class="sd">        gf_computed (bool): Whether or not Green&#39;s functions have been computed for this</span>
<span class="sd">            object</span>
<span class="sd">        filtered_gf_st (:class:`~obspy.core.stream.Stream`): Stream containing filtered</span>
<span class="sd">            Green&#39;s functions</span>
<span class="sd">        inversion_complete (bool): Whether or not the inversion has been run</span>
<span class="sd">        filter (dict): Dictionary with keys ``&#39;freqmin&#39;``, ``&#39;freqmax&#39;``,</span>
<span class="sd">            ``&#39;zerophase&#39;``, ``&#39;periodmin&#39;``, ``&#39;periodmax&#39;``, and ``&#39;order&#39;``</span>
<span class="sd">            specifying filter parameters</span>
<span class="sd">        data_length (int): Length in samples of each data trace</span>
<span class="sd">        force_sampling_rate (int or float): [Hz] The sampling rate of the force-time</span>
<span class="sd">            function</span>
<span class="sd">        W (2D array): Weight matrix</span>
<span class="sd">        Wvec (1D array): Weight vector</span>
<span class="sd">        jackknife (:class:`~obspy.core.util.attribdict.AttribDict`): Dictionary with</span>
<span class="sd">            keys ``&#39;Z&#39;``, ``&#39;N&#39;``, ``&#39;E&#39;``, ``&#39;VR_all&#39;``, ``&#39;alphas&#39;``, ``&#39;num_iter&#39;``,</span>
<span class="sd">            and ``&#39;frac_delete&#39;`` containing jackknife parameters and results</span>
<span class="sd">        angle_magnitude (:class:`~obspy.core.util.attribdict.AttribDict`): Dictionary</span>
<span class="sd">            with keys ``&#39;magnitude&#39;``, ``&#39;magnitude_upper&#39;``, ``&#39;magnitude_lower&#39;``,</span>
<span class="sd">            ``&#39;vertical_angle&#39;``, and ``&#39;horizontal_angle&#39;`` containing inversion angle</span>
<span class="sd">            and magnitude information</span>
<span class="sd">        G (2D array): Design matrix</span>
<span class="sd">        d (1D array): Data vector</span>
<span class="sd">        model: Model vector of concatenated components (n x 1) of solution</span>
<span class="sd">        Z: [N] Vertical force time series extracted from model (positive up)</span>
<span class="sd">        N: [N] North force time series extracted from model (positive north)</span>
<span class="sd">        E: [N] East force time series extracted from model (positive east)</span>
<span class="sd">        tvec: [s] Time vector for forces, referenced using `zero_time` (if specified)</span>
<span class="sd">        VR: [%] Variance reduction. Rule of thumb: This should be ~50–80%, if ~100%,</span>
<span class="sd">            solution is fitting data exactly and results are suspect. If ~5%, model may</span>
<span class="sd">            be wrong or something else may be wrong with setup</span>
<span class="sd">        dtorig: Original data vector</span>
<span class="sd">        dtnew: Modeled data vector (Gm-d)</span>
<span class="sd">        alpha: Regularization parameter that was used</span>
<span class="sd">        alphafit (dict): Dictionary with keys ``&#39;alphas&#39;``, ``&#39;fit&#39;``, and ``&#39;size&#39;``</span>
<span class="sd">            specifying regularization parameters tested</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_sampling_rate</span><span class="p">,</span> <span class="n">main_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Create an LSForce object.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (:class:`~lsforce.lsdata.LSData`): LSData object, corrected for station</span>
<span class="sd">                response but not filtered</span>
<span class="sd">            data_sampling_rate (int or float): [Hz] Samples per second to use in</span>
<span class="sd">                inversion. All data will be resampled to this rate, and Green&#39;s</span>
<span class="sd">                functions will be created with this rate</span>
<span class="sd">            main_folder (str): If `None`, will use current folder</span>
<span class="sd">            method (str): How to parameterize the force-time function. One of `&#39;full&#39;`</span>
<span class="sd">                — full inversion using Tikhonov regularization (L2 norm minimization) or</span>
<span class="sd">                `&#39;triangle&#39;` — inversion parameterized using overlapping triangles,</span>
<span class="sd">                variation on method of Ekström &amp; Stark (2013)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_sampling_rate</span> <span class="o">=</span> <span class="n">data_sampling_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gf_computed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inversion_complete</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">main_folder</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_folder</span> <span class="o">=</span> <span class="n">main_folder</span>

        <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="s1">&#39;triangle&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Method </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1"> not yet implemented.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>

    <span class="k">def</span> <span class="nf">_get_greens</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get the Green&#39;s function Stream using either Syngine or CPS.&quot;&quot;&quot;</span>

        <span class="c1"># Name the directory where GFs will be stored based on method</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cps_model</span><span class="p">:</span>
            <span class="n">gf_dir_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;cps_</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cps_model</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gf_dir_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;syngine_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">syngine_model</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gf_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_folder</span><span class="p">,</span> <span class="n">gf_dir_name</span><span class="p">)</span>

        <span class="c1"># Label directories containing triangular GFs as such</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;triangle&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gf_dir</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;_triangle_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">triangle_half_width</span><span class="si">:</span><span class="s1">g</span><span class="si">}</span><span class="s1">s&#39;</span>

        <span class="c1"># Make GF directory if it doesn&#39;t exist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gf_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gf_dir</span><span class="p">)</span>

        <span class="c1"># Choose the correct delta</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cps_model</span><span class="p">:</span>
            <span class="n">gf_dt</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_sampling_rate</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gf_dt</span> <span class="o">=</span> <span class="n">SYNGINE_DT</span>

        <span class="c1"># Get list of unique stations</span>
        <span class="n">unique_stations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">([</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">st_proc</span><span class="p">])</span>

        <span class="c1"># Make lists of stations with and without GFs calculated/downloaded</span>
        <span class="n">existing_stations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stations_to_calculate</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">unique_stations</span><span class="p">:</span>

            <span class="n">distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">st_proc</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="n">station</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">distance</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gf_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s1">.pkl&#39;</span><span class="p">)</span>

            <span class="c1"># Check if this EXACT GF exists already</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                <span class="n">stats</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">stats</span><span class="o">.</span><span class="n">syngine_model</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">syngine_model</span>
                    <span class="ow">and</span> <span class="n">stats</span><span class="o">.</span><span class="n">cps_model</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cps_model</span>
                    <span class="ow">and</span> <span class="n">stats</span><span class="o">.</span><span class="n">triangle_half_width</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">triangle_half_width</span>
                    <span class="ow">and</span> <span class="n">stats</span><span class="o">.</span><span class="n">sourcedepthinmeters</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_depth</span>
                    <span class="ow">and</span> <span class="n">stats</span><span class="o">.</span><span class="n">distance</span> <span class="o">==</span> <span class="n">distance</span>
                    <span class="ow">and</span> <span class="n">stats</span><span class="o">.</span><span class="n">T0</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">T0</span>
                    <span class="ow">and</span> <span class="n">stats</span><span class="o">.</span><span class="n">duration</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">gf_duration</span>
                    <span class="ow">and</span> <span class="n">stats</span><span class="o">.</span><span class="n">delta</span> <span class="o">==</span> <span class="n">gf_dt</span>
                <span class="p">):</span>
                    <span class="n">gf_exists</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">gf_exists</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gf_exists</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Append to the correct vector</span>
            <span class="k">if</span> <span class="n">gf_exists</span><span class="p">:</span>
                <span class="n">existing_stations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">station</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stations_to_calculate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">station</span><span class="p">)</span>

        <span class="c1"># Initialize empty Stream to hold all GFs</span>
        <span class="n">st_gf</span> <span class="o">=</span> <span class="n">Stream</span><span class="p">()</span>

        <span class="c1"># CPS</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cps_model</span><span class="p">:</span>

            <span class="c1"># If we have to calculate some stations, go through the process</span>
            <span class="k">if</span> <span class="n">stations_to_calculate</span><span class="p">:</span>

                <span class="c1"># Print status</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Calculating Green</span><span class="se">\&#39;</span><span class="s1">s functions for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">stations_to_calculate</span><span class="p">)</span><span class="si">}</span><span class="s1"> &#39;</span>
                    <span class="s1">&#39;station(s):&#39;</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">stations_to_calculate</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="c1"># Create a temporary directory to run CPS in, and change into it</span>
                <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
                <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">temp_dir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="c1"># Write the &quot;dist&quot; file</span>
                <span class="n">gf_length_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gf_duration</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_sampling_rate</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;dist&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="n">stations_to_calculate</span><span class="p">:</span>
                        <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">st_proc</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="n">sta</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">distance</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dist</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">gf_dt</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">gf_length_samples</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">T0</span><span class="si">}</span><span class="s1"> 0</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="c1"># Run hprep96 and hspec96</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="s1">&#39;hprep96&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;-HR&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;0.&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;-HS&#39;</span><span class="p">,</span>
                        <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_depth</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">),</span>  <span class="c1"># Converting to km for CPS</span>
                        <span class="s1">&#39;-M&#39;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cps_model</span><span class="p">,</span>
                        <span class="s1">&#39;-d&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;dist&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;-R&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;-EXF&#39;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;hspec96.out&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;hspec96&#39;</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>

                <span class="c1"># Run hpulse96 (using the multiplier here to get a 1 N impulse), also</span>
                <span class="c1"># keep track of pulse half-width so we can make the GFs acausal later</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hpulse96&#39;</span><span class="p">,</span> <span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;dist&#39;</span><span class="p">,</span> <span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="mf">1e-10</span><span class="si">:</span><span class="s1">.10f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;-OD&#39;</span><span class="p">,</span> <span class="s1">&#39;-V&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">triangle_half_width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;-l&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">triangle_half_width</span> <span class="o">/</span> <span class="n">gf_dt</span><span class="p">))]</span>
                    <span class="n">pulse_half_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">triangle_half_width</span>  <span class="c1"># [s]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;-p&#39;</span><span class="p">]</span>
                    <span class="n">pulse_half_width</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">gf_dt</span>  <span class="c1"># [s]</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;Green&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>

                <span class="c1"># Convert to SAC files</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s1">&#39;f96tosac&#39;</span><span class="p">,</span> <span class="s1">&#39;Green&#39;</span><span class="p">])</span>

                <span class="c1"># Go through and read in files (same order as dist file)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">station</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stations_to_calculate</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;B</span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">:</span><span class="s1">03d</span><span class="si">}</span><span class="s1">1???F.sac&#39;</span><span class="p">):</span>

                        <span class="c1"># Grab stats of data trace</span>
                        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">st_proc</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="n">station</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span>

                        <span class="c1"># Read GF in as an ObsPy Trace</span>
                        <span class="n">gf_tr</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                        <span class="c1"># Add metadata</span>
                        <span class="n">gf_tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">network</span>
                        <span class="n">gf_tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span> <span class="o">=</span> <span class="n">station</span>
                        <span class="n">gf_tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="s1">&#39;SE&#39;</span>
                        <span class="n">gf_tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">distance</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">distance</span>
                        <span class="n">gf_tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">syngine_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">syngine_model</span>
                        <span class="n">gf_tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">cps_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cps_model</span>
                        <span class="n">gf_tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sourcedepthinmeters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_depth</span>
                        <span class="n">gf_tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">T0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T0</span>
                        <span class="n">gf_tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gf_duration</span>
                        <span class="n">gf_tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">triangle_half_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">triangle_half_width</span>

                        <span class="n">gf_tr</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="mf">0.01</span>  <span class="c1"># Convert from cm to m</span>

                        <span class="c1"># Add Trace to overall GF Stream</span>
                        <span class="n">st_gf</span> <span class="o">+=</span> <span class="n">gf_tr</span>

                <span class="c1"># Clean up</span>
                <span class="n">temp_dir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

                <span class="c1"># Trim to length (gf_duration - T0) seconds, and correct for the pulse</span>
                <span class="c1"># half-width to make GFs acausal (since the -Z flag doesn&#39;t work!)</span>
                <span class="n">starttime</span> <span class="o">=</span> <span class="n">st_gf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span>
                <span class="n">endtime</span> <span class="o">=</span> <span class="n">starttime</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">gf_duration</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">T0</span>
                <span class="n">st_gf</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span> <span class="o">+</span> <span class="n">pulse_half_width</span><span class="p">,</span> <span class="n">endtime</span> <span class="o">+</span> <span class="n">pulse_half_width</span><span class="p">)</span>

                <span class="c1"># Give a nice start time</span>
                <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st_gf</span><span class="p">:</span>
                    <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">=</span> <span class="n">GF_STARTTIME</span>

                <span class="c1"># Save as individual files</span>
                <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">stations_to_calculate</span><span class="p">:</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gf_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s1">.pkl&#39;</span><span class="p">)</span>
                    <span class="n">st_gf</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="n">station</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;PICKLE&#39;</span><span class="p">)</span>

            <span class="c1"># Now just load in the GFs which already exist</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">station</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">existing_stations</span><span class="p">):</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gf_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s1">.pkl&#39;</span><span class="p">)</span>
                <span class="n">st_gf</span> <span class="o">+=</span> <span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

                <span class="c1"># Print status</span>
                <span class="n">progress</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stations_to_calculate</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">progress</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_stations</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

        <span class="c1"># Syngine</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># Go station-by-station</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">station</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_stations</span><span class="p">):</span>

                <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gf_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s1">.pkl&#39;</span><span class="p">)</span>

                <span class="c1"># Either load this GF if it already exists, or download it</span>
                <span class="k">if</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">existing_stations</span><span class="p">:</span>
                    <span class="n">st_syn</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Grab stats of data trace</span>
                    <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">st_proc</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="n">station</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span>

                    <span class="c1"># Get GFs for this station</span>
                    <span class="n">st_syn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_greens_for_station</span><span class="p">(</span>
                        <span class="n">receiverlatitude</span><span class="o">=</span><span class="n">stats</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
                        <span class="n">receiverlongitude</span><span class="o">=</span><span class="n">stats</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
                        <span class="n">back_azimuth</span><span class="o">=</span><span class="n">stats</span><span class="o">.</span><span class="n">back_azimuth</span><span class="p">,</span>
                        <span class="n">distance</span><span class="o">=</span><span class="n">stats</span><span class="o">.</span><span class="n">distance</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="c1"># Add metadata, as Syngine uses &#39;XX&#39; and &#39;SYN&#39; by default</span>
                    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st_syn</span><span class="p">:</span>
                        <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">network</span>
                        <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">station</span>

                    <span class="c1"># TODO: Understand why we have to flip the polarity of these!</span>
                    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="s1">&#39;RHF&#39;</span><span class="p">,</span> <span class="s1">&#39;RVF&#39;</span><span class="p">,</span> <span class="s1">&#39;THF&#39;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st_syn</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">):</span>
                            <span class="n">tr</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

                    <span class="n">st_syn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;PICKLE&#39;</span><span class="p">)</span>

                <span class="c1"># Add this station&#39;s GFs to overall Stream</span>
                <span class="n">st_gf</span> <span class="o">+=</span> <span class="n">st_syn</span>

                <span class="c1"># Print status</span>
                <span class="k">if</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">existing_stations</span><span class="p">:</span>
                    <span class="n">action_string</span> <span class="o">=</span> <span class="s1">&#39;Found&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">action_string</span> <span class="o">=</span> <span class="s1">&#39;Downloaded&#39;</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">action_string</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_stations</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gf_computed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">st_gf</span>

    <span class="k">def</span> <span class="nf">_get_greens_for_station</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">receiverlatitude</span><span class="p">,</span> <span class="n">receiverlongitude</span><span class="p">,</span> <span class="n">back_azimuth</span><span class="p">,</span> <span class="n">distance</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get the Green&#39;s functions for a single station (Syngine).&quot;&quot;&quot;</span>

        <span class="c1"># Provide triangle STF params if we&#39;re using the triangle method</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;triangle&#39;</span><span class="p">:</span>
            <span class="n">stf_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">triangle_half_width</span>  <span class="c1"># Ensure peak of triangle at t=0</span>
            <span class="n">stf_spacing</span> <span class="o">=</span> <span class="n">TRIANGLE_STF_DT</span>
            <span class="c1"># The below construction ensures the triangle is centered on 1 and goes to 0</span>
            <span class="c1"># at each end, e.g. [0, 0.5, 1, 0.5, 0] instead of [0.25, 0.75, 0.75, 0.25]</span>
            <span class="n">stf_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="n">triang</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">triangle_half_width</span> <span class="o">/</span> <span class="n">TRIANGLE_STF_DT</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="mi">0</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">read_func</span> <span class="o">=</span> <span class="n">_read</span>  <span class="c1"># Use the long-URL wrapper for ObsPy read</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stf_offset</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">stf_spacing</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">stf_data</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">read_func</span> <span class="o">=</span> <span class="n">read</span>  <span class="c1"># Just directly read using ObsPy</span>

        <span class="c1"># Convert to radians for NumPy</span>
        <span class="n">back_azimuth_radians</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">back_azimuth</span><span class="p">)</span>

        <span class="c1"># Vertical force (downward)</span>
        <span class="n">st_vf</span> <span class="o">=</span> <span class="n">read_func</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build_syngine_url</span><span class="p">(</span>
                <span class="n">receiverlatitude</span><span class="o">=</span><span class="n">receiverlatitude</span><span class="p">,</span>
                <span class="n">receiverlongitude</span><span class="o">=</span><span class="n">receiverlongitude</span><span class="p">,</span>
                <span class="n">components</span><span class="o">=</span><span class="s1">&#39;ZR&#39;</span><span class="p">,</span>
                <span class="n">forces</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">stf_offset</span><span class="o">=</span><span class="n">stf_offset</span><span class="p">,</span>
                <span class="n">stf_spacing</span><span class="o">=</span><span class="n">stf_spacing</span><span class="p">,</span>
                <span class="n">stf_data</span><span class="o">=</span><span class="n">stf_data</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st_vf</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;Z&#39;</span><span class="p">):</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="s1">&#39;ZVF&#39;</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st_vf</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;R&#39;</span><span class="p">):</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="s1">&#39;RVF&#39;</span>

        <span class="c1"># Horizontal force (radial)</span>
        <span class="n">st_hf_r</span> <span class="o">=</span> <span class="n">read_func</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build_syngine_url</span><span class="p">(</span>
                <span class="n">receiverlatitude</span><span class="o">=</span><span class="n">receiverlatitude</span><span class="p">,</span>
                <span class="n">receiverlongitude</span><span class="o">=</span><span class="n">receiverlongitude</span><span class="p">,</span>
                <span class="n">components</span><span class="o">=</span><span class="s1">&#39;ZR&#39;</span><span class="p">,</span>
                <span class="n">forces</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">back_azimuth_radians</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">back_azimuth_radians</span><span class="p">)),</span>
                <span class="n">stf_offset</span><span class="o">=</span><span class="n">stf_offset</span><span class="p">,</span>
                <span class="n">stf_spacing</span><span class="o">=</span><span class="n">stf_spacing</span><span class="p">,</span>
                <span class="n">stf_data</span><span class="o">=</span><span class="n">stf_data</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st_hf_r</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;Z&#39;</span><span class="p">):</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="s1">&#39;ZHF&#39;</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st_hf_r</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;R&#39;</span><span class="p">):</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="s1">&#39;RHF&#39;</span>

        <span class="c1"># Horizontal force (transverse)</span>
        <span class="n">st_hf_t</span> <span class="o">=</span> <span class="n">read_func</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build_syngine_url</span><span class="p">(</span>
                <span class="n">receiverlatitude</span><span class="o">=</span><span class="n">receiverlatitude</span><span class="p">,</span>
                <span class="n">receiverlongitude</span><span class="o">=</span><span class="n">receiverlongitude</span><span class="p">,</span>
                <span class="n">components</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">,</span>
                <span class="n">forces</span><span class="o">=</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">back_azimuth_radians</span><span class="p">),</span>
                    <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">back_azimuth_radians</span><span class="p">),</span>
                <span class="p">),</span>
                <span class="n">stf_offset</span><span class="o">=</span><span class="n">stf_offset</span><span class="p">,</span>
                <span class="n">stf_spacing</span><span class="o">=</span><span class="n">stf_spacing</span><span class="p">,</span>
                <span class="n">stf_data</span><span class="o">=</span><span class="n">stf_data</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st_hf_t</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">):</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="s1">&#39;THF&#39;</span>

        <span class="c1"># Assemble big Stream</span>
        <span class="n">st_syn</span> <span class="o">=</span> <span class="n">st_vf</span> <span class="o">+</span> <span class="n">st_hf_r</span> <span class="o">+</span> <span class="n">st_hf_t</span>

        <span class="c1"># Add metadata and sort</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st_syn</span><span class="p">:</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">distance</span> <span class="o">=</span> <span class="n">distance</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">cps_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cps_model</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">syngine_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">syngine_model</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sourcedepthinmeters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_depth</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">T0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T0</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gf_duration</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">triangle_half_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">triangle_half_width</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">=</span> <span class="n">GF_STARTTIME</span>  <span class="c1"># Give a nice start time</span>
        <span class="n">st_syn</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">st_syn</span>

    <span class="k">def</span> <span class="nf">_build_syngine_url</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">receiverlatitude</span><span class="p">,</span>
        <span class="n">receiverlongitude</span><span class="p">,</span>
        <span class="n">components</span><span class="p">,</span>
        <span class="n">forces</span><span class="p">,</span>
        <span class="n">stf_offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">stf_spacing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">stf_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Build a URL to be fed to Syngine.&quot;&quot;&quot;</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;format=miniseed&#39;</span><span class="p">,</span>
            <span class="s1">&#39;components=&#39;</span> <span class="o">+</span> <span class="n">components</span><span class="p">,</span>
            <span class="s1">&#39;units=displacement&#39;</span><span class="p">,</span>
            <span class="s1">&#39;model=&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">syngine_model</span><span class="p">,</span>
            <span class="s1">&#39;dt=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">SYNGINE_DT</span><span class="p">),</span>
            <span class="s1">&#39;starttime=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T0</span><span class="p">),</span>
            <span class="s1">&#39;endtime=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gf_duration</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">T0</span><span class="p">),</span>
            <span class="s1">&#39;receiverlatitude=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">receiverlatitude</span><span class="p">),</span>
            <span class="s1">&#39;receiverlongitude=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">receiverlongitude</span><span class="p">),</span>
            <span class="s1">&#39;sourcelatitude=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">source_lat</span><span class="p">),</span>
            <span class="s1">&#39;sourcelongitude=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">source_lon</span><span class="p">),</span>
            <span class="s1">&#39;sourcedepthinmeters=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_depth</span><span class="p">),</span>
            <span class="s1">&#39;sourceforce=&#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">force</span><span class="p">)</span> <span class="k">for</span> <span class="n">force</span> <span class="ow">in</span> <span class="n">forces</span><span class="p">]),</span>
            <span class="s1">&#39;nodata=404&#39;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">stf_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">stf_spacing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">stf_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parameters</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="s1">&#39;cstf-relative-origin-time-in-sec=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">stf_offset</span><span class="p">),</span>
                <span class="s1">&#39;cstf-sample-spacing-in-sec=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">stf_spacing</span><span class="p">),</span>
                <span class="s1">&#39;cstf-data=&#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">stf_data</span><span class="p">]),</span>
            <span class="p">]</span>
        <span class="k">elif</span> <span class="n">stf_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">stf_spacing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">stf_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;All three CSTF parameters must be provided!&#39;</span><span class="p">)</span>

        <span class="n">url</span> <span class="o">=</span> <span class="n">SYNGINE_BASE_URL</span> <span class="o">+</span> <span class="s1">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">url</span>

<div class="viewcode-block" id="LSForce.setup"><a class="viewcode-back" href="../../api/lsforce.lsforce.html#lsforce.lsforce.LSForce.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">period_range</span><span class="p">,</span>
        <span class="n">syngine_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cps_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">triangle_half_width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">source_depth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">noise_window_dur</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">filter_order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">zerophase</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Downloads/computes Green&#39;s functions (GFs) and creates all matrices.</span>

<span class="sd">        Args:</span>
<span class="sd">            period_range (list or tuple): [s] Bandpass filter corners</span>
<span class="sd">            syngine_model (str): Name of Syngine model to use. If this is not None, then</span>
<span class="sd">                we calculate GFs using Syngine (preferred)</span>
<span class="sd">            cps_model (str): Filename of CPS model to use. If this is not None, then we</span>
<span class="sd">                calculate GFs using CPS</span>
<span class="sd">            triangle_half_width (int or float): [s] Half-width of triangles; only used</span>
<span class="sd">                if the triangle method is being used</span>
<span class="sd">            source_depth (int or float): [m] Source depth in meters</span>
<span class="sd">            weights (list or tuple or str): If `None`, no weighting is applied. An array</span>
<span class="sd">                of floats with length ``st.count()`` and in the order of the `st`</span>
<span class="sd">                applies manual weighting. If `&#39;prenoise&#39;`, uses standard deviation of</span>
<span class="sd">                a noise window defined by `noise_window_dur` to weight. If `&#39;distance&#39;`,</span>
<span class="sd">                weights by 1/distance</span>
<span class="sd">            noise_window_dur (int or float): [s] Length of noise window for `&#39;prenoise&#39;`</span>
<span class="sd">                weighting scheme (if not `None`, `weights` is set to `&#39;prenoise&#39;`)</span>
<span class="sd">            filter_order (int): Order of filter applied over period_range</span>
<span class="sd">            zerophase (bool): If `True`, zero-phase filtering will be used</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">syngine_model</span> <span class="o">=</span> <span class="n">syngine_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_depth</span> <span class="o">=</span> <span class="n">source_depth</span>

        <span class="c1"># Explicitly ignore the triangle half-width parameter if it&#39;s not relevant</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;triangle&#39;</span> <span class="ow">and</span> <span class="n">triangle_half_width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">triangle_half_width</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s1">&#39;Ignoring `triangle_half_width` parameter since you</span><span class="se">\&#39;</span><span class="s1">re not using the &#39;</span>
                <span class="s1">&#39;triangle method.&#39;</span>
            <span class="p">)</span>

        <span class="c1"># Make sure user specifies the triangle half-width if they want that method</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;triangle&#39;</span> <span class="ow">and</span> <span class="n">triangle_half_width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;triangle method is specified but no half-width given!&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triangle_half_width</span> <span class="o">=</span> <span class="n">triangle_half_width</span>

        <span class="c1"># If user wants CPS to be run, make sure that 1) they have it installed; 2) it</span>
        <span class="c1"># runs; and 3) they have provided a valid filepath</span>
        <span class="k">if</span> <span class="n">cps_model</span><span class="p">:</span>
            <span class="c1"># 1) Is CPS installed?</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">which</span><span class="p">(</span><span class="s1">&#39;hprep96&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
                    <span class="s1">&#39;CPS Green</span><span class="se">\&#39;</span><span class="s1">s function calculation requested, but CPS not found on &#39;</span>
                    <span class="s1">&#39;system. Install CPS and try again.&#39;</span>
                <span class="p">)</span>
            <span class="c1"># 2) Does CPS run?</span>
            <span class="k">if</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;hprep96&#39;</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;Issue with CPS. Check install and try again.&#39;</span><span class="p">)</span>
            <span class="c1"># 3) Is `cps_model` a file?</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cps_model</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not find CPS model file &quot;</span><span class="si">{</span><span class="n">cps_model</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cps_model</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">cps_model</span><span class="p">)</span>  <span class="c1"># Get full path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cps_model</span> <span class="o">=</span> <span class="n">cps_model</span>

        <span class="c1"># The user must specify ONE of `syngine_model` and `cps_model`</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syngine_model</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cps_model</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">syngine_model</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cps_model</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You must specify ONE of syngine_model or cps_model!&#39;</span><span class="p">)</span>

        <span class="c1"># Automatically choose an appropriate T0 and GF duration based on data/method</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;triangle&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">T0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">triangle_half_width</span>  <span class="c1"># [s] Double the half-width</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">T0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>  <span class="c1"># [s]</span>
        <span class="n">min_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">st_proc</span><span class="p">])</span>
        <span class="n">max_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">st_proc</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gf_duration</span> <span class="o">=</span> <span class="n">max_time</span> <span class="o">-</span> <span class="n">min_time</span>  <span class="c1"># [s]</span>

        <span class="c1"># Create filter dictionary to keep track of filter used without creating too</span>
        <span class="c1"># many new attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;freqmin&#39;</span><span class="p">:</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">period_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;freqmax&#39;</span><span class="p">:</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">period_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;zerophase&#39;</span><span class="p">:</span> <span class="n">zerophase</span><span class="p">,</span>
            <span class="s1">&#39;periodmin&#39;</span><span class="p">:</span> <span class="n">period_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;periodmax&#39;</span><span class="p">:</span> <span class="n">period_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="n">filter_order</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Clear weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Wvec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Don&#39;t weight at all</span>
            <span class="n">weight_method</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># The user specified a weight method</span>
            <span class="n">weight_method</span> <span class="o">=</span> <span class="n">weights</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># The user specified a vector of station weights</span>
            <span class="n">weight_method</span> <span class="o">=</span> <span class="s1">&#39;Manual&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span>

        <span class="k">if</span> <span class="n">weight_method</span> <span class="o">!=</span> <span class="s1">&#39;Manual&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">weights</span> <span class="o">==</span> <span class="s1">&#39;prenoise&#39;</span> <span class="ow">and</span> <span class="n">noise_window_dur</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;noise_window_dur must be defined if prenoise weighting is used.&#39;</span>
                <span class="p">)</span>

        <span class="c1"># Check if sampling rate specified is compatible with period_range</span>
        <span class="k">if</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">[</span><span class="s1">&#39;freqmax&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_sampling_rate</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;data_sampling_rate and period_range are not compatible (violates &#39;</span>
                <span class="s1">&#39;Nyquist).&#39;</span>
            <span class="p">)</span>

        <span class="c1"># Always work on copy of data</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">st_proc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Filter data to band specified</span>
        <span class="n">st</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="s1">&#39;bandpass&#39;</span><span class="p">,</span>
            <span class="n">freqmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">[</span><span class="s1">&#39;freqmin&#39;</span><span class="p">],</span>
            <span class="n">freqmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">[</span><span class="s1">&#39;freqmax&#39;</span><span class="p">],</span>
            <span class="n">corners</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">],</span>
            <span class="n">zerophase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">[</span><span class="s1">&#39;zerophase&#39;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Resample st to data_sampling_rate</span>
        <span class="n">st</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sampling_rate</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="s1">&#39;hann&#39;</span><span class="p">)</span>

        <span class="c1"># Make sure st data are all the same length</span>
        <span class="n">lens</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">st</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lens</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s1">&#39;Resampled records are of differing lengths. Interpolating all records &#39;</span>
                <span class="s1">&#39;to same start time and sampling rate.&#39;</span>
            <span class="p">)</span>
            <span class="n">stts</span> <span class="o">=</span> <span class="p">[</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st</span><span class="p">]</span>
            <span class="n">lens</span> <span class="o">=</span> <span class="p">[</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st</span><span class="p">]</span>
            <span class="n">st</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_sampling_rate</span><span class="p">,</span> <span class="n">starttime</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">stts</span><span class="p">),</span> <span class="n">npts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lens</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_length</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span>
        <span class="n">total_data_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_length</span> <span class="o">*</span> <span class="n">st</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

        <span class="c1"># Load in GFs</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Getting Green</span><span class="se">\&#39;</span><span class="s1">s functions...&#39;</span><span class="p">)</span>
        <span class="n">st_gf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_greens</span><span class="p">()</span>

        <span class="c1"># Process GFs in bulk</span>
        <span class="n">st_gf</span><span class="o">.</span><span class="n">detrend</span><span class="p">()</span>
        <span class="n">st_gf</span><span class="o">.</span><span class="n">taper</span><span class="p">(</span><span class="n">max_percentage</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">st_gf</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="s1">&#39;bandpass&#39;</span><span class="p">,</span>
            <span class="n">freqmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">[</span><span class="s1">&#39;freqmin&#39;</span><span class="p">],</span>
            <span class="n">freqmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">[</span><span class="s1">&#39;freqmax&#39;</span><span class="p">],</span>
            <span class="n">corners</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">],</span>
            <span class="n">zerophase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">[</span><span class="s1">&#39;zerophase&#39;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">syngine_model</span><span class="p">:</span>  <span class="c1"># Only need to do this if Syngine</span>
            <span class="n">st_gf</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
                <span class="n">sampling_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sampling_rate</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;lanczos&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mi">20</span>
            <span class="p">)</span>
        <span class="n">st_gf</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">])</span>

        <span class="c1"># Store the filtered GFs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtered_gf_st</span> <span class="o">=</span> <span class="n">st_gf</span>

        <span class="c1"># Initialize weighting matrices</span>
        <span class="n">Wvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">total_data_length</span><span class="p">)</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">st_proc</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

        <span class="c1"># Store data length</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_length</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="c1"># Set sampling rate</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force_sampling_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_sampling_rate</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;triangle&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force_sampling_rate</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">triangle_half_width</span>
            <span class="c1"># Number of samples to shift each triangle by</span>
            <span class="n">fshiftby</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">triangle_half_width</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_sampling_rate</span><span class="p">)</span>
            <span class="c1"># Number of shifts, corresponds to length of force time function</span>
            <span class="n">Flen</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_length</span> <span class="o">/</span> <span class="n">fshiftby</span><span class="p">))</span>
            <span class="c1"># Triangle GFs are multiplied by the triangle half-width so that they</span>
            <span class="c1"># reflect the ground motion induced for a triangle with PEAK 1 N instead of</span>
            <span class="c1"># AREA of 1 N*s</span>
            <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st_gf</span><span class="p">:</span>
                <span class="n">tr</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">triangle_half_width</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Method </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s1"> not supported.&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">st</span><span class="p">):</span>

            <span class="c1"># Find component and station of Trace</span>
            <span class="n">component</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">station</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span>

            <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span>
                <span class="n">zvf</span> <span class="o">=</span> <span class="n">st_gf</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="n">station</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="s1">&#39;ZVF&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">zhf</span> <span class="o">=</span> <span class="n">st_gf</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="n">station</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="s1">&#39;ZHF&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
                    <span class="n">ZVF</span> <span class="o">=</span> <span class="n">_makeconvmat</span><span class="p">(</span><span class="n">zvf</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
                    <span class="n">ZHF</span> <span class="o">=</span> <span class="n">_makeconvmat</span><span class="p">(</span><span class="n">zhf</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ZVF</span> <span class="o">=</span> <span class="n">_makeshiftmat</span><span class="p">(</span><span class="n">zvf</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">shiftby</span><span class="o">=</span><span class="n">fshiftby</span><span class="p">,</span> <span class="n">size1</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">Flen</span><span class="p">))</span>
                    <span class="n">ZHF</span> <span class="o">=</span> <span class="n">_makeshiftmat</span><span class="p">(</span><span class="n">zhf</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">shiftby</span><span class="o">=</span><span class="n">fshiftby</span><span class="p">,</span> <span class="n">size1</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">Flen</span><span class="p">))</span>
                <span class="n">az_radians</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">azimuth</span><span class="p">)</span>
                <span class="n">newline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">ZVF</span><span class="p">,</span> <span class="n">ZHF</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">az_radians</span><span class="p">),</span> <span class="n">ZHF</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">az_radians</span><span class="p">)]</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;R&#39;</span><span class="p">:</span>
                <span class="n">rvf</span> <span class="o">=</span> <span class="n">st_gf</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="n">station</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="s1">&#39;RVF&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">rhf</span> <span class="o">=</span> <span class="n">st_gf</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="n">station</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="s1">&#39;RHF&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
                    <span class="n">RVF</span> <span class="o">=</span> <span class="n">_makeconvmat</span><span class="p">(</span><span class="n">rvf</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
                    <span class="n">RHF</span> <span class="o">=</span> <span class="n">_makeconvmat</span><span class="p">(</span><span class="n">rhf</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">RVF</span> <span class="o">=</span> <span class="n">_makeshiftmat</span><span class="p">(</span><span class="n">rvf</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">shiftby</span><span class="o">=</span><span class="n">fshiftby</span><span class="p">,</span> <span class="n">size1</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">Flen</span><span class="p">))</span>
                    <span class="n">RHF</span> <span class="o">=</span> <span class="n">_makeshiftmat</span><span class="p">(</span><span class="n">rhf</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">shiftby</span><span class="o">=</span><span class="n">fshiftby</span><span class="p">,</span> <span class="n">size1</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">Flen</span><span class="p">))</span>
                <span class="n">az_radians</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">azimuth</span><span class="p">)</span>
                <span class="n">newline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">RVF</span><span class="p">,</span> <span class="n">RHF</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">az_radians</span><span class="p">),</span> <span class="n">RHF</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">az_radians</span><span class="p">)]</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span>
                <span class="n">thf</span> <span class="o">=</span> <span class="n">st_gf</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="n">station</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="s1">&#39;THF&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
                    <span class="n">THF</span> <span class="o">=</span> <span class="n">_makeconvmat</span><span class="p">(</span><span class="n">thf</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">THF</span> <span class="o">=</span> <span class="n">_makeshiftmat</span><span class="p">(</span><span class="n">thf</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">shiftby</span><span class="o">=</span><span class="n">fshiftby</span><span class="p">,</span> <span class="n">size1</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">Flen</span><span class="p">))</span>
                <span class="n">TVF</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">*</span> <span class="n">THF</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Just zeros for TVF</span>
                <span class="n">az_radians</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">azimuth</span><span class="p">)</span>
                <span class="n">newline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">TVF</span><span class="p">,</span> <span class="n">THF</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">az_radians</span><span class="p">),</span> <span class="o">-</span><span class="n">THF</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">az_radians</span><span class="p">)]</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data not rotated to ZRT for </span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

            <span class="c1"># Deal with data</span>
            <span class="n">datline</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">data</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># If this is the first station, initialize G and d</span>
                <span class="n">G</span> <span class="o">=</span> <span class="n">newline</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">datline</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Otherwise build on G and d</span>
                <span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">G</span><span class="p">,</span> <span class="n">newline</span><span class="o">.</span><span class="n">copy</span><span class="p">()))</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">d</span><span class="p">,</span> <span class="n">datline</span><span class="o">.</span><span class="n">copy</span><span class="p">()))</span>

            <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">weight_method</span> <span class="o">==</span> <span class="s1">&#39;Manual&#39;</span><span class="p">:</span>
                    <span class="n">weight</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">weights</span> <span class="o">==</span> <span class="s1">&#39;prenoise&#39;</span><span class="p">:</span>
                    <span class="n">weight</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span>
                        <span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">noise_window_dur</span> <span class="o">*</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">)]</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">weights</span> <span class="o">==</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span>
                    <span class="n">weight</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">distance</span>

                <span class="n">Wvec</span><span class="p">[</span><span class="n">indx</span> <span class="p">:</span> <span class="n">indx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">Wvec</span><span class="p">[</span><span class="n">indx</span> <span class="p">:</span> <span class="n">indx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">indx</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_length</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="c1"># Need to multiply G by sample interval [s] since convolution is an integral</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">G</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_sampling_rate</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># We don&#39;t need to scale the triangle method GFs by the sample rate since</span>
            <span class="c1"># this method is not a convolution</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">G</span>

        <span class="c1"># Normalize Wvec so largest weight is 1.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Wvec</span> <span class="o">=</span> <span class="n">Wvec</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Wvec</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weight</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">weight</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">G</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;G and d sizes are not compatible, fix something somewhere.&#39;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">d</span>
        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Wvec</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="LSForce.invert"><a class="viewcode-back" href="../../api/lsforce.lsforce.html#lsforce.lsforce.LSForce.invert">[docs]</a>    <span class="k">def</span> <span class="nf">invert</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">zero_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">impose_zero_start</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">add_to_zero</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">jackknife</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">num_iter</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
        <span class="n">frac_delete</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">zero_scaler</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
        <span class="n">zero_start_taper_length</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">tikhonov_ratios</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
        <span class="n">jk_refine_alpha</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">save_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Performs single-force inversion using Tikhonov regularization.</span>

<span class="sd">        Args:</span>
<span class="sd">            zero_time (int or float): [s] Optional estimated start time of real</span>
<span class="sd">                (landslide-related) part of signal, in seconds from start time of</span>
<span class="sd">                seismic data. Useful for making figures showing selected start time and</span>
<span class="sd">                also for the `impose_zero_start` option</span>
<span class="sd">            impose_zero_start (bool): Adds weighting matrix to suggest that forces tend</span>
<span class="sd">                towards zero prior to `zero_time` (`zero_time` must be defined)</span>
<span class="sd">            add_to_zero (bool): Adds weighting matrix to suggest that all components of</span>
<span class="sd">                force integrate to zero</span>
<span class="sd">            duration (int or float): Maximum duration allowed for the event, starting at</span>
<span class="sd">                `zero_time` if defined, otherwise starting from the beginning of the</span>
<span class="sd">                seismic data. Forces after this will tend towards zero. This helps tamp</span>
<span class="sd">                down artifacts due to edge effects, etc.</span>
<span class="sd">            jackknife (bool): If `True`, perform `num_iter` additional iterations of the</span>
<span class="sd">                model while randomly discarding `frac_delete` of the data</span>
<span class="sd">            num_iter (int): Number of jackknife iterations to perform</span>
<span class="sd">            frac_delete (int or float): Fraction (out of 1) of data to discard for each</span>
<span class="sd">                iteration, if frac_delete=1, will do leave a one out error analysis</span>
<span class="sd">            alpha (int or float): Set regularization parameter. If `None`, will search</span>
<span class="sd">                for best alpha using the L-curve method</span>
<span class="sd">            zero_scaler (int or float): Relative strength of zero constraint for</span>
<span class="sd">                `impose_zero_start` and `duration` options. Ranges from 0 to 10. The</span>
<span class="sd">                lower the number, the weaker the constraint. Values up to 30 are</span>
<span class="sd">                technically allowed but discouraged because high `zero_scaler` values</span>
<span class="sd">                risk the addition of high frequency oscillations due to the sudden</span>
<span class="sd">                release of the constraint</span>
<span class="sd">            zero_start_taper_length (int or float): [s] Length of taper for</span>
<span class="sd">                `impose_zero_start` option</span>
<span class="sd">            tikhonov_ratios (list or tuple): Proportion each regularization method</span>
<span class="sd">                contributes to the overall regularization effect, where values</span>
<span class="sd">                correspond to [0th order, 1st order, 2nd order]. Must sum to 1</span>
<span class="sd">            jk_refine_alpha (bool): Refine the alpha parameter used for each jackknife</span>
<span class="sd">                iteration by searching over order of magnitude around the best alpha</span>
<span class="sd">                for the full solution. If `False`, each jackknife iteration will use the</span>
<span class="sd">                same alpha as the main solution (note that this is much faster but can</span>
<span class="sd">                result in some jackknife iterations having depressed amplitudes)</span>
<span class="sd">            save_matrices (bool): If True, will save the inverted matrices as</span>
<span class="sd">                part of the object (Ghat, dhat, I, L1, L2) in case user wants</span>
<span class="sd">                to do additional alpha searching</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check inputs</span>
        <span class="k">if</span> <span class="n">impose_zero_start</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">zero_time</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;impose_zero_start set to True but no zero_time provided.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">zero_scaler</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">zero_scaler</span> <span class="o">&gt;</span> <span class="mf">30.0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;zero_scaler cannot be less than 0 or more than 30&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tikhonov_ratios</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Tikhonov ratios must add to 1.&#39;</span><span class="p">)</span>

        <span class="c1"># Save input choices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_to_zero</span> <span class="o">=</span> <span class="n">add_to_zero</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zero_time</span> <span class="o">=</span> <span class="n">zero_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impose_zero_start</span> <span class="o">=</span> <span class="n">impose_zero_start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="n">duration</span>

        <span class="c1"># Initialize (also serves to clear any previous results if this is a rerun)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tvec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VR</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtorig</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtnew</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alphafit</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;alphas&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;fit&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle_magnitude</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">jackknife</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">frac_delete</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="c1"># If frac_delete is one, do leave one out analysis instead</span>
                <span class="n">num_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">st_proc</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            <span class="c1"># Initialize</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span> <span class="o">=</span> <span class="n">AttribDict</span><span class="p">(</span>
                <span class="n">Z</span><span class="o">=</span><span class="n">AttribDict</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="p">[],</span> <span class="n">upper</span><span class="o">=</span><span class="p">[],</span> <span class="nb">all</span><span class="o">=</span><span class="p">[]),</span>
                <span class="n">N</span><span class="o">=</span><span class="n">AttribDict</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="p">[],</span> <span class="n">upper</span><span class="o">=</span><span class="p">[],</span> <span class="nb">all</span><span class="o">=</span><span class="p">[]),</span>
                <span class="n">E</span><span class="o">=</span><span class="n">AttribDict</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="p">[],</span> <span class="n">upper</span><span class="o">=</span><span class="p">[],</span> <span class="nb">all</span><span class="o">=</span><span class="p">[]),</span>
                <span class="n">VR_all</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">num_iter</span><span class="o">=</span><span class="n">num_iter</span><span class="p">,</span>
                <span class="n">frac_delete</span><span class="o">=</span><span class="n">frac_delete</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Ghat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">)</span>
            <span class="n">dhat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Ghat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span>
            <span class="n">dhat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Save version at this point for use later</span>
            <span class="n">Ghatori</span> <span class="o">=</span> <span class="n">Ghat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">dhatori</span> <span class="o">=</span> <span class="n">dhat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">Ghat</span><span class="p">)</span>

        <span class="n">Ghatnorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Ghat</span><span class="p">)</span>

        <span class="n">dl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_length</span>
        <span class="n">gl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Force vector length</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_to_zero</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># Constrain forces to add to zero</span>
            <span class="n">scaler</span> <span class="o">=</span> <span class="n">Ghatnorm</span>
            <span class="n">first1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">gl</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">gl</span><span class="p">)))</span>
            <span class="n">second1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">gl</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">gl</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">gl</span><span class="p">)))</span>
            <span class="n">third1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">gl</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">gl</span><span class="p">)))</span>
            <span class="n">A1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">first1</span><span class="p">,</span> <span class="n">second1</span><span class="p">,</span> <span class="n">third1</span><span class="p">))</span> <span class="o">*</span> <span class="n">scaler</span>
            <span class="n">Ghat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">Ghat</span><span class="p">,</span> <span class="n">A1</span><span class="p">))</span>
            <span class="n">dhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">dhat</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">A1</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">scaler</span> <span class="o">=</span> <span class="n">Ghatnorm</span> <span class="o">*</span> <span class="p">(</span><span class="n">zero_scaler</span> <span class="o">/</span> <span class="mf">30.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">impose_zero_start</span><span class="p">:</span>  <span class="c1"># Tell model when there should be no forces</span>
            <span class="n">len2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">zero_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">T0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_sampling_rate</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;triangle&#39;</span><span class="p">:</span>
                <span class="c1"># No taper</span>
                <span class="n">vals2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">len2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">gl</span> <span class="o">-</span> <span class="n">len2</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
                <span class="c1"># Taper</span>
                <span class="n">len3</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">zero_start_taper_length</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_sampling_rate</span><span class="p">)</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hanning</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">len3</span><span class="p">)</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">len3</span><span class="p">:]</span>
                <span class="n">vals2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">len2</span> <span class="o">-</span> <span class="n">len3</span><span class="p">),</span> <span class="n">temp</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vals2</span><span class="p">):</span>
                <span class="n">first1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">gl</span><span class="p">)</span>
                <span class="n">second1</span> <span class="o">=</span> <span class="n">first1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">third1</span> <span class="o">=</span> <span class="n">first1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">first1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="n">second1</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">gl</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="n">third1</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">gl</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">A2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">first1</span><span class="p">,</span> <span class="n">second1</span><span class="p">,</span> <span class="n">third1</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">A2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">A2</span><span class="p">,</span> <span class="n">first1</span><span class="p">,</span> <span class="n">second1</span><span class="p">,</span> <span class="n">third1</span><span class="p">))</span>
            <span class="n">A2</span> <span class="o">*=</span> <span class="n">scaler</span>
            <span class="n">Ghat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">Ghat</span><span class="p">,</span> <span class="n">A2</span><span class="p">))</span>
            <span class="n">dhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">dhat</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vals2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">A2</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">zerotime</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">zerotime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_time</span>
            <span class="n">startind</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="p">(</span><span class="n">zerotime</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">T0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_sampling_rate</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;triangle&#39;</span><span class="p">:</span>
                <span class="n">vals3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">gl</span><span class="p">)</span>
                <span class="n">vals3</span><span class="p">[</span><span class="n">startind</span><span class="p">:]</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># No taper</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vals3</span><span class="p">):</span>
                    <span class="n">first1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">gl</span><span class="p">)</span>
                    <span class="n">second1</span> <span class="o">=</span> <span class="n">first1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">third1</span> <span class="o">=</span> <span class="n">first1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">first1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                        <span class="n">second1</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">gl</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                        <span class="n">third1</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">gl</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">A3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">first1</span><span class="p">,</span> <span class="n">second1</span><span class="p">,</span> <span class="n">third1</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">A3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">A3</span><span class="p">,</span> <span class="n">first1</span><span class="p">,</span> <span class="n">second1</span><span class="p">,</span> <span class="n">third1</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
                <span class="n">len2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">gl</span> <span class="o">-</span> <span class="n">startind</span><span class="p">)</span>
                <span class="n">len3</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">len2</span><span class="p">)</span>
                <span class="p">)</span>  <span class="c1"># 20% taper so zero imposition isn&#39;t sudden</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hanning</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">len3</span><span class="p">)</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[:</span><span class="n">len3</span><span class="p">]</span>
                <span class="n">vals3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">temp</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">len2</span> <span class="o">-</span> <span class="n">len3</span><span class="p">)))</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vals3</span><span class="p">):</span>
                    <span class="n">place</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">startind</span>
                    <span class="n">first1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">gl</span><span class="p">)</span>
                    <span class="n">second1</span> <span class="o">=</span> <span class="n">first1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">third1</span> <span class="o">=</span> <span class="n">first1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">first1</span><span class="p">[</span><span class="n">place</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                        <span class="n">second1</span><span class="p">[</span><span class="n">place</span> <span class="o">+</span> <span class="n">gl</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                        <span class="n">third1</span><span class="p">[</span><span class="n">place</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">gl</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">A3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">first1</span><span class="p">,</span> <span class="n">second1</span><span class="p">,</span> <span class="n">third1</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">A3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">A3</span><span class="p">,</span> <span class="n">first1</span><span class="p">,</span> <span class="n">second1</span><span class="p">,</span> <span class="n">third1</span><span class="p">))</span>
            <span class="n">A3</span> <span class="o">*=</span> <span class="n">scaler</span>

            <span class="n">Ghat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">Ghat</span><span class="p">,</span> <span class="n">A3</span><span class="p">))</span>
            <span class="n">dhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">dhat</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vals3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">A3</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">dhat</span> <span class="o">=</span> <span class="n">dhat</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Build roughening matrix</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tikhonov_ratios</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="c1"># Build L1 (first order) roughening matrix</span>
            <span class="n">L1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">L1part</span> <span class="o">=</span> <span class="n">L1</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">L1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">L1part</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">L1</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">tikhonov_ratios</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="c1"># Build L2 (second order) roughening matrix</span>
            <span class="n">L2</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
                <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">L2part</span> <span class="o">=</span> <span class="n">L2</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">L2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">L2</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">L2part</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">alpha</span><span class="p">:</span>
            <span class="n">alpha</span><span class="p">,</span> <span class="n">fit1</span><span class="p">,</span> <span class="n">size1</span><span class="p">,</span> <span class="n">alphas</span> <span class="o">=</span> <span class="n">find_alpha</span><span class="p">(</span>
                <span class="n">Ghat</span><span class="p">,</span> <span class="n">dhat</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">L1</span><span class="p">,</span> <span class="n">L2</span><span class="p">,</span> <span class="n">tikhonov_ratios</span><span class="o">=</span><span class="n">tikhonov_ratios</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;best alpha is </span><span class="si">{</span><span class="n">alpha</span><span class="si">:</span><span class="s1">6.1e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alphafit</span><span class="p">[</span><span class="s1">&#39;alphas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alphas</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alphafit</span><span class="p">[</span><span class="s1">&#39;fit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alphafit</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size1</span>
            <span class="k">if</span> <span class="n">save_matrices</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matrices</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">Ghat</span><span class="o">=</span><span class="n">Ghat</span><span class="p">,</span>
                    <span class="n">dhat</span><span class="o">=</span><span class="n">dhat</span><span class="p">,</span>
                    <span class="n">I</span><span class="o">=</span><span class="n">I</span><span class="p">,</span>
                    <span class="n">L1</span><span class="o">=</span><span class="n">L1</span><span class="p">,</span>
                    <span class="n">L2</span><span class="o">=</span><span class="n">L2</span><span class="p">,</span>
                    <span class="n">tikhonov_ratios</span><span class="o">=</span><span class="n">tikhonov_ratios</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matrices</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>

        <span class="n">Apart</span> <span class="o">=</span> <span class="n">Ghat</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Ghat</span>

        <span class="n">A</span> <span class="o">=</span> <span class="n">Apart</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">tikhonov_ratios</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">I</span>
            <span class="o">+</span> <span class="n">tikhonov_ratios</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">L1part</span>
            <span class="o">+</span> <span class="n">tikhonov_ratios</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">L2part</span>
        <span class="p">)</span>  <span class="c1"># Combo of all regularization things (if any are zero they won&#39;t matter)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">Ghat</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">dhat</span><span class="p">)</span>

        <span class="n">model</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">div</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Flip so up is positive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">=</span> <span class="o">-</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">div</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="n">div</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">div</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">div</span> <span class="p">:]</span>

        <span class="n">dtnew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtnew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dtnew</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">st_proc</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">dl</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtorig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">st_proc</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">dl</span><span class="p">))</span>

        <span class="c1"># Compute variance reduction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VR</span> <span class="o">=</span> <span class="n">_varred</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtorig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtnew</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Variance reduction = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">VR</span><span class="si">:</span><span class="s1">f</span><span class="si">}</span><span class="s1"> percent&#39;</span><span class="p">)</span>
        <span class="n">tvec</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_sampling_rate</span><span class="p">,</span>
                <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_sampling_rate</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">T0</span>
        <span class="p">)</span>

        <span class="c1"># Adjust time vector for zero time, if one was provided</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tvec</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tvec</span> <span class="o">=</span> <span class="n">tvec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_length</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_sampling_rate</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_sampling_rate</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dtvec</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_time</span>
        <span class="c1"># Use constant alpha parameter (found above, if not previously set) for</span>
        <span class="c1"># jackknife iterations</span>
        <span class="n">stasets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">alphajs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">frac_delete</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Starting leave-one-out analysis&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Starting jackknife iterations&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">num_iter</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">frac_delete</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">indxcut</span> <span class="o">=</span> <span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                    <span class="n">numkeep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">num_iter</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">numcut</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                        <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">frac_delete</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">st_proc</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
                    <span class="p">)</span>
                    <span class="n">numkeep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">st_proc</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">-</span> <span class="n">numcut</span>
                    <span class="n">indxcut</span> <span class="o">=</span> <span class="n">rnd</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">st_proc</span><span class="o">.</span><span class="n">count</span><span class="p">())),</span> <span class="n">numcut</span><span class="p">)</span>
                <span class="n">stasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indxcut</span><span class="p">)</span>

                <span class="n">obj</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="nb">sum</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="n">indxcut</span><span class="p">)),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">x1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_length</span> <span class="k">for</span> <span class="n">x1</span> <span class="ow">in</span> <span class="n">indxcut</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_length</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">]</span>

                <span class="n">dhat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">dhatori</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">obj</span><span class="p">)</span>
                <span class="n">Ghat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">Ghatori</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">obj</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="n">Gtemp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">obj</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">dtemp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">obj</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">A1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Use A1, A2, A3 from full solution, if exist</span>
                    <span class="n">Ghat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">Ghat1</span><span class="p">,</span> <span class="n">A1</span><span class="p">))</span>
                    <span class="n">dhat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">dhat1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">A2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">Ghat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">Ghat1</span><span class="p">,</span> <span class="n">A2</span><span class="p">))</span>
                    <span class="n">dhat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">dhat1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vals2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">A3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">Ghat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">Ghat1</span><span class="p">,</span> <span class="n">A3</span><span class="p">))</span>
                    <span class="n">dhat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">dhat1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vals3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)))</span>

                <span class="n">dhat1</span> <span class="o">=</span> <span class="n">dhat1</span><span class="o">.</span><span class="n">T</span>
                <span class="n">Apart</span> <span class="o">=</span> <span class="n">Ghat1</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Ghat1</span>

                <span class="k">if</span> <span class="n">jk_refine_alpha</span><span class="p">:</span>
                    <span class="c1"># Fine tune the alpha</span>
                    <span class="n">rndalph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
                    <span class="n">alphaj</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="o">=</span> <span class="n">find_alpha</span><span class="p">(</span>
                        <span class="n">Ghat1</span><span class="p">,</span>
                        <span class="n">dhat1</span><span class="p">,</span>
                        <span class="n">I</span><span class="p">,</span>
                        <span class="n">L1</span><span class="p">,</span>
                        <span class="n">L2</span><span class="p">,</span>
                        <span class="n">tikhonov_ratios</span><span class="o">=</span><span class="n">tikhonov_ratios</span><span class="p">,</span>
                        <span class="n">rough</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">int_rough</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                        <span class="n">range_rough</span><span class="o">=</span><span class="p">(</span><span class="n">rndalph</span> <span class="o">-</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">rndalph</span> <span class="o">+</span> <span class="mf">0.4</span><span class="p">),</span>
                        <span class="n">plot_Lcurve</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">alphaj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
                <span class="n">alphajs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alphaj</span><span class="p">)</span>

                <span class="c1"># Combo of all regularization things (if any are zero they won&#39;t matter)</span>
                <span class="n">Aj</span> <span class="o">=</span> <span class="n">Apart</span> <span class="o">+</span> <span class="n">alphaj</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">tikhonov_ratios</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">I</span>
                    <span class="o">+</span> <span class="n">tikhonov_ratios</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">L1part</span>
                    <span class="o">+</span> <span class="n">tikhonov_ratios</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">L2part</span>
                <span class="p">)</span>
                <span class="n">xj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">Ghat1</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">dhat1</span><span class="p">)</span>

                <span class="n">model</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">Aj</span><span class="p">,</span> <span class="n">xj</span><span class="p">)</span>
                <span class="n">div</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">Zf</span> <span class="o">=</span> <span class="o">-</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">div</span><span class="p">]</span>  <span class="c1"># Flip so up is positive</span>
                <span class="n">Nf</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="n">div</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">div</span><span class="p">]</span>
                <span class="n">Ef</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">div</span> <span class="p">:]</span>
                <span class="n">dtnew</span> <span class="o">=</span> <span class="n">Gtemp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dtemp</span><span class="p">,</span> <span class="p">(</span><span class="n">numkeep</span><span class="p">,</span> <span class="n">dl</span><span class="p">))</span>

                <span class="n">VR</span> <span class="o">=</span> <span class="n">_varred</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">dtnew</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Zf</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Nf</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ef</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">VR_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">VR</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

            <span class="c1"># Calculate bounds of jackknife runs (these bounds do not necessarily</span>
            <span class="c1"># represent a single run and in fact are more likely to be composites of</span>
            <span class="c1"># several runs)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">alphas</span> <span class="o">=</span> <span class="n">alphajs</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">VR_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">VR_all</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Jackknife VR stats: max </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">VR_all</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s1">2.0f</span><span class="si">}</span><span class="s1">, &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;min </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">VR_all</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s1">2.0f</span><span class="si">}</span><span class="s1">, &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;median </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">VR_all</span><span class="p">)</span><span class="si">:</span><span class="s1">2.0f</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>

        <span class="c1"># Calculate angles and magnitudes</span>
        <span class="n">Mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Calculate magnitude of each jackknife run</span>
            <span class="n">mag_all</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">z</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">all</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">all</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">all</span>
                <span class="p">)</span>
            <span class="p">]</span>
            <span class="c1"># Calculate magnitude bounds</span>
            <span class="n">MagL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">mag_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">MagU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mag_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">MagU</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">MagL</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">Vang</span> <span class="o">=</span> <span class="p">(</span><span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="c1"># Get angle counterclockwise relative to N</span>
        <span class="n">tempang</span> <span class="o">=</span> <span class="p">(</span><span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">)</span> <span class="o">-</span> <span class="mi">90</span>
        <span class="c1"># For any negative values, add 360</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">temp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tempang</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">temp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tempang</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">+</span> <span class="mi">360</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tempangU</span> <span class="o">=</span> <span class="p">(</span><span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">upper</span>
            <span class="p">)</span> <span class="o">-</span> <span class="mi">90</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">temp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tempangU</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">temp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">tempangU</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">+</span> <span class="mi">360</span>
            <span class="n">tempangL</span> <span class="o">=</span> <span class="p">(</span><span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">lower</span>
            <span class="p">)</span> <span class="o">-</span> <span class="mi">90</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">temp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tempangL</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">temp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">tempangL</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">+</span> <span class="mi">360</span>
        <span class="c1"># Now flip to clockwise to get azimuth</span>
        <span class="n">Haz</span> <span class="o">=</span> <span class="mi">360</span> <span class="o">-</span> <span class="n">tempang</span>

        <span class="c1"># Store angles and magnitudes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle_magnitude</span> <span class="o">=</span> <span class="n">AttribDict</span><span class="p">(</span>
            <span class="n">magnitude</span><span class="o">=</span><span class="n">Mag</span><span class="p">,</span>
            <span class="n">magnitude_upper</span><span class="o">=</span><span class="n">MagU</span><span class="p">,</span>
            <span class="n">magnitude_lower</span><span class="o">=</span><span class="n">MagL</span><span class="p">,</span>
            <span class="n">vertical_angle</span><span class="o">=</span><span class="n">Vang</span><span class="p">,</span>
            <span class="n">horizontal_angle</span><span class="o">=</span><span class="n">Haz</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">inversion_complete</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="LSForce.forward"><a class="viewcode-back" href="../../api/lsforce.lsforce.html#lsforce.lsforce.LSForce.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">E</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Execute the forward problem :math:`\mathbf{d} = \mathbf{G}\mathbf{m}`</span>
<span class="sd">        using a user-supplied force time series :math:`\mathbf{m}` composed of</span>
<span class="sd">        components `Z`, `N`, and `E`.</span>

<span class="sd">        Args:</span>
<span class="sd">            Z: [N] Vertical force time series (positive up)</span>
<span class="sd">            N: [N] North force time series (positive north)</span>
<span class="sd">            E: [N] East force time series (positive east)</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`~obspy.core.stream.Stream`: [m] Stream containing synthetic</span>
<span class="sd">            data, :math:`\mathbf{d}`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check if G is defined</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">gf_computed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;G is not defined. Did you run LSForce.setup()?&#39;</span><span class="p">)</span>

        <span class="c1"># Convert and check sizes</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">E</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">vec</span> <span class="ow">in</span> <span class="n">Z</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">E</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">vec</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_length</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;Each force component must have length </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="si">}</span><span class="s1">!&#39;</span>

        <span class="c1"># Form model vector</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="o">-</span><span class="n">Z</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">E</span><span class="p">])</span>

        <span class="c1"># KEY: Forward problem</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">model</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">))</span>

        <span class="c1"># Form Stream</span>
        <span class="n">st_syn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">st_proc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Quick way to pre-populate metadata</span>
        <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">tr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">st_syn</span><span class="p">):</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_sampling_rate</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="s1">&#39;SE&#39;</span>  <span class="c1"># Synthetics Engine</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">_get_band_code</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;X&#39;</span> <span class="o">+</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">component</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="s1">&#39;_fdsnws_dataselect_url&#39;</span><span class="p">,</span>
                <span class="s1">&#39;_format&#39;</span><span class="p">,</span>
                <span class="s1">&#39;mseed&#39;</span><span class="p">,</span>
                <span class="s1">&#39;processing&#39;</span><span class="p">,</span>
                <span class="s1">&#39;response&#39;</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="c1"># Remove N/A metadata</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span>  <span class="c1"># If the key doesn&#39;t exist, just proceed silently</span>

        <span class="k">return</span> <span class="n">st_syn</span></div>

<div class="viewcode-block" id="LSForce.plot_fits"><a class="viewcode-back" href="../../api/lsforce.lsforce.html#lsforce.lsforce.LSForce.plot_fits">[docs]</a>    <span class="k">def</span> <span class="nf">plot_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equal_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Create a plot showing the model-produced waveform fit to the data.</span>

<span class="sd">        Args:</span>
<span class="sd">            equal_scale (bool): If `True`, all plots will share the same y-axis scale</span>
<span class="sd">            xlim (list or tuple): [s] Array (length two) of x-axis limits (time relative</span>
<span class="sd">                to zero time)</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`~matplotlib.figure.Figure`: Output figure handle</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">data_color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span>
        <span class="n">model_color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
        <span class="n">lw</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">equal_scale</span><span class="p">:</span>
            <span class="n">amp_string</span> <span class="o">=</span> <span class="s1">&#39;normalized&#39;</span>
            <span class="n">spacing</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">amp_string</span> <span class="o">=</span> <span class="s1">&#39;equal scale&#39;</span>
            <span class="n">spacing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtorig</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># Spacing controlled by largest amp</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">yticks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">yticklabels</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">st_proc</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">equal_scale</span><span class="p">:</span>
                <span class="n">scaler</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtorig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>  <span class="c1"># Scale to original data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scaler</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dtvec</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dtorig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">scaler</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">data_color</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dtvec</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dtnew</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">scaler</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">model_color</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">) &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;– </span><span class="si">{</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">distance</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> km&#39;</span>
            <span class="p">)</span>
            <span class="n">yticklabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">yticks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">-=</span> <span class="n">spacing</span>

        <span class="c1"># Misc. tweaks</span>
        <span class="k">if</span> <span class="n">xlim</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtvec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtvec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">yticks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">spacing</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">yticks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">spacing</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">yticklabels</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Variance reduction </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">VR</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">% (</span><span class="si">{</span><span class="n">amp_string</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># Make legend</span>
        <span class="n">data_handle</span> <span class="o">=</span> <span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span>
            <span class="p">[],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="n">data_color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">lw</span>
        <span class="p">)</span>
        <span class="n">model_handle</span> <span class="o">=</span> <span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span>
            <span class="p">[],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="n">model_color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Model&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">lw</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">data_handle</span><span class="p">,</span> <span class="n">model_handle</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="LSForce.plot_forces"><a class="viewcode-back" href="../../api/lsforce.lsforce.html#lsforce.lsforce.LSForce.plot_forces">[docs]</a>    <span class="k">def</span> <span class="nf">plot_forces</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">subplots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">same_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">highf_tr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">hfshift</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">hfylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">infra_tr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">infra_shift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">jackshowall</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Plot inversion result.</span>

<span class="sd">        Args:</span>
<span class="sd">            subplots (bool): If `True`, make subplots for components, otherwise plot all</span>
<span class="sd">                on one plot</span>
<span class="sd">            xlim (list or tuple): x-axis limits</span>
<span class="sd">            ylim (list or tuple): y-axis limits</span>
<span class="sd">            same_y (bool): If `True`, use same y-axis limits for all plots</span>
<span class="sd">            highf_tr (:class:`~obspy.core.trace.Trace`): Seismic trace with start time</span>
<span class="sd">                identical to start time of the data used in the inversion</span>
<span class="sd">            hfshift (int or float): [s] Time shift for seismic trace</span>
<span class="sd">            hfylabel (str): Label used for seismic trace. If not defined, will use</span>
<span class="sd">                station name</span>
<span class="sd">            infra_tr (:class:`~obspy.core.trace.Trace`): Infrasound trace with start</span>
<span class="sd">                time identical to start time of the data used in the inversion</span>
<span class="sd">            infra_shift (int or float): [s] Time shift for infrasound trace</span>
<span class="sd">            jackshowall (bool): If `True` and jackknife was run, will show all</span>
<span class="sd">                individual runs (changes `subplots` to `True`)</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`~matplotlib.figure.Figure`: Output figure handle</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tvec</span>

        <span class="n">annot_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.99</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>

        <span class="c1"># Find y limits</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ylim1</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">min</span><span class="p">()]),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">()]),</span>
                <span class="p">)</span>
                <span class="c1"># Add 10% on each side to make it look nicer</span>
                <span class="n">ylim</span> <span class="o">=</span> <span class="p">(</span><span class="n">ylim1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">ylim1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylim1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">ylim1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Zupper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">upper</span>
            <span class="n">Nupper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">upper</span>
            <span class="n">Eupper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">upper</span>
            <span class="n">Zlower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">lower</span>
            <span class="n">Nlower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">lower</span>
            <span class="n">Elower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">lower</span>
            <span class="k">if</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ylim1</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">Zlower</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                            <span class="n">Elower</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                            <span class="n">Nlower</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                        <span class="p">]</span>
                    <span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">Zupper</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                            <span class="n">Eupper</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                            <span class="n">Nupper</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                        <span class="p">]</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="c1"># Add 10% on each side to make it look nicer</span>
                <span class="n">ylim</span> <span class="o">=</span> <span class="p">(</span><span class="n">ylim1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">ylim1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylim1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">ylim1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">jackshowall</span><span class="p">:</span>
            <span class="n">subplots</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">subplots</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">highf_tr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">infra_tr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">,</span> <span class="n">ax5</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                        <span class="n">nrows</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
                    <span class="p">)</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tvec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span> <span class="n">Z_COLOR</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Up force (N)&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tvec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">N_COLOR</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;North force (N)&#39;</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tvec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="n">E_COLOR</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;East force (N)&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">jackshowall</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">Z</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">E</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">all</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">all</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">all</span><span class="p">,</span>
                    <span class="p">):</span>
                        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tvec</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">Z_COLOR</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">JK_ALPHA</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tvec</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N_COLOR</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">JK_ALPHA</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tvec</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">E_COLOR</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">JK_ALPHA</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                        <span class="n">tvec</span><span class="p">,</span> <span class="n">Zlower</span><span class="p">,</span> <span class="n">Zupper</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">Z_COLOR</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">JK_ALPHA</span>
                    <span class="p">)</span>
                    <span class="n">ax2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                        <span class="n">tvec</span><span class="p">,</span> <span class="n">Nlower</span><span class="p">,</span> <span class="n">Nupper</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">N_COLOR</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">JK_ALPHA</span>
                    <span class="p">)</span>
                    <span class="n">ax3</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                        <span class="n">tvec</span><span class="p">,</span> <span class="n">Elower</span><span class="p">,</span> <span class="n">Eupper</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">E_COLOR</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">JK_ALPHA</span>
                    <span class="p">)</span>
            <span class="k">if</span> <span class="n">highf_tr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">highf_tr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Trace</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;highf_tr is not an ObsPy Trace.&#39;</span><span class="p">)</span>
                <span class="n">tvec2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">highf_tr</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">highf_tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">,</span>
                    <span class="n">num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">highf_tr</span><span class="o">.</span><span class="n">data</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="c1"># Temporary fix, adjust for same zero time</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_time</span><span class="p">:</span>
                    <span class="n">tvec2</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_time</span>
                <span class="n">tvec2</span> <span class="o">-=</span> <span class="n">hfshift</span>
                <span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tvec2</span><span class="p">,</span> <span class="n">highf_tr</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">UMS_PER_MS</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">)</span>
                <span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Velocity (μm/s)&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">infra_tr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">infra_tr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Trace</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;infra_tr is not an ObsPy Trace.&#39;</span><span class="p">)</span>
                <span class="n">tvec2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">infra_tr</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">infra_tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">,</span>
                    <span class="n">num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">infra_tr</span><span class="o">.</span><span class="n">data</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="c1"># Temporary fix, adjust for same zero time</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_time</span><span class="p">:</span>
                    <span class="n">tvec2</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_time</span>
                <span class="n">tvec2</span> <span class="o">-=</span> <span class="n">infra_shift</span>
                <span class="n">ax5</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tvec2</span><span class="p">,</span> <span class="n">infra_tr</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">)</span>
                <span class="n">ax5</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pressure (Pa)&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">infra_shift</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ax5</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">infra_tr</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> (shifted –</span><span class="si">{</span><span class="n">infra_shift</span><span class="si">:</span><span class="s1">1.0f</span><span class="si">}</span><span class="s1"> s)&#39;</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">annot_kwargs</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax5</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">infra_tr</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="o">**</span><span class="n">annot_kwargs</span><span class="p">)</span>

                <span class="c1"># Remove x-axis labels for plots above this one</span>
                <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">]:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">xlim</span><span class="p">:</span>
                <span class="n">xlim</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tvec</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">tvec</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_axes</span><span class="p">()</span>
            <span class="p">[</span><span class="n">axe</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span> <span class="k">for</span> <span class="n">axe</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">]</span>
            <span class="p">[</span><span class="n">axe</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">axe</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">same_y</span> <span class="ow">or</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
                <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">impose_zero_start</span><span class="p">:</span>
                <span class="p">[</span><span class="n">axe</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">axe</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="p">[</span>
                    <span class="n">axe</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">axe</span> <span class="ow">in</span> <span class="n">axes</span>
                <span class="p">]</span>
            <span class="k">if</span> <span class="n">highf_tr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">hfylabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">hfylabel</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">hfshift</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ax4</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">highf_tr</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> (shifted –</span><span class="si">{</span><span class="n">hfshift</span><span class="si">:</span><span class="s1">1.0f</span><span class="si">}</span><span class="s1"> s)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">annot_kwargs</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax4</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">highf_tr</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="o">**</span><span class="n">annot_kwargs</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">highf_tr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ax4</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">highf_tr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Trace</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;highf_tr is not an ObsPy Trace.&#39;</span><span class="p">)</span>
                <span class="n">tvec2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">highf_tr</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">highf_tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">,</span>
                    <span class="n">num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">highf_tr</span><span class="o">.</span><span class="n">data</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="c1"># Temporary fix, adjust for same zerotime</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_time</span><span class="p">:</span>
                    <span class="n">tvec2</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_time</span>
                <span class="n">tvec2</span> <span class="o">-=</span> <span class="n">hfshift</span>
                <span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tvec2</span><span class="p">,</span> <span class="n">highf_tr</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">UMS_PER_MS</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">)</span>
                <span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Velocity (μm/s)&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">hfshift</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ax4</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">highf_tr</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> - shifted –</span><span class="si">{</span><span class="n">hfshift</span><span class="si">:</span><span class="s1">1.0f</span><span class="si">}</span><span class="s1"> s&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">annot_kwargs</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax4</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">highf_tr</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="o">**</span><span class="n">annot_kwargs</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tvec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span> <span class="n">Z_COLOR</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Up&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tvec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">N_COLOR</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;North&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tvec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="n">E_COLOR</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;East&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">tvec</span><span class="p">,</span> <span class="n">Zlower</span><span class="p">,</span> <span class="n">Zupper</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">Z_COLOR</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">JK_ALPHA</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">tvec</span><span class="p">,</span> <span class="n">Nlower</span><span class="p">,</span> <span class="n">Nupper</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">N_COLOR</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">JK_ALPHA</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">tvec</span><span class="p">,</span> <span class="n">Elower</span><span class="p">,</span> <span class="n">Eupper</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">E_COLOR</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">JK_ALPHA</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">xlim</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">highf_tr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax4</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">())</span>
                <span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hfylabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">hfylabel</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Force (N)&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">impose_zero_start</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">st_proc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_time</span><span class="p">:</span>
            <span class="n">t0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_time</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s) from </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t0</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)))</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="LSForce.plot_angle_magnitude"><a class="viewcode-back" href="../../api/lsforce.lsforce.html#lsforce.lsforce.LSForce.plot_angle_magnitude">[docs]</a>    <span class="k">def</span> <span class="nf">plot_angle_magnitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Plot angles and magnitudes of inversion result.</span>

<span class="sd">        Args:</span>
<span class="sd">            xlim (list or tuple): x-axis limits</span>
<span class="sd">            ylim (list or tuple): y-axis limits</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`~matplotlib.figure.Figure`: Output figure handle</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tvec</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ylim1</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">min</span><span class="p">()]),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">()]),</span>
                <span class="p">)</span>
                <span class="c1"># Add 10% on each side to make it look nicer</span>
                <span class="n">ylim</span> <span class="o">=</span> <span class="p">(</span><span class="n">ylim1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">ylim1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylim1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">ylim1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Zupper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">upper</span>
            <span class="n">Nupper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">upper</span>
            <span class="n">Eupper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">upper</span>
            <span class="n">Zlower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">lower</span>
            <span class="n">Nlower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">lower</span>
            <span class="n">Elower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">lower</span>

            <span class="k">if</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ylim1</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">([</span><span class="n">Zlower</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">Elower</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">Nlower</span><span class="o">.</span><span class="n">min</span><span class="p">()]),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">([</span><span class="n">Zupper</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">Eupper</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">Nupper</span><span class="o">.</span><span class="n">max</span><span class="p">()]),</span>
                <span class="p">)</span>
            <span class="c1"># Add 10% on each side to make it look nicer</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="p">(</span><span class="n">ylim1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">ylim1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylim1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">ylim1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

        <span class="c1"># Plot the inversion result in the first one</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">411</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tvec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span> <span class="n">Z_COLOR</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Up&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tvec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">N_COLOR</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;North&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tvec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="n">E_COLOR</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;East&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">tvec</span><span class="p">,</span> <span class="n">Zlower</span><span class="p">,</span> <span class="n">Zupper</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">Z_COLOR</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">JK_ALPHA</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">tvec</span><span class="p">,</span> <span class="n">Nlower</span><span class="p">,</span> <span class="n">Nupper</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">N_COLOR</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">JK_ALPHA</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">tvec</span><span class="p">,</span> <span class="n">Elower</span><span class="p">,</span> <span class="n">Eupper</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">E_COLOR</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">JK_ALPHA</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">xlim</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Force (N)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>

        <span class="c1"># Plot the magnitudes in second one</span>
        <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">412</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tvec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_magnitude</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Best&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># Calculate magnitude of each jackknife run</span>
            <span class="n">mag_all</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">z</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">all</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">all</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">all</span>
                <span class="p">)</span>
            <span class="p">]</span>

            <span class="c1"># Plot mean magnitude as dashed line</span>
            <span class="n">Mag_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mag_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tvec</span><span class="p">,</span> <span class="n">Mag_mean</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean&#39;</span><span class="p">)</span>

            <span class="c1"># Plot magnitude bounds as grey patch (these bounds do not</span>
            <span class="c1"># necessarily represent a single run&#39;s magnitude and in fact are more likely</span>
            <span class="c1"># to be composites of several runs)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                <span class="n">tvec</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">angle_magnitude</span><span class="o">.</span><span class="n">magnitude_upper</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">angle_magnitude</span><span class="o">.</span><span class="n">magnitude_lower</span><span class="p">,</span>
                <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="n">JK_ALPHA</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Add legend</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Force (N)&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Plot the horizontal azimuth</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">413</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tvec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_magnitude</span><span class="o">.</span><span class="n">horizontal_angle</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Azimuth (deg CW from N)&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>

        <span class="c1"># Plot the vertical angle</span>
        <span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">414</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tvec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_magnitude</span><span class="o">.</span><span class="n">vertical_angle</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Vertical angle (deg)&#39;</span><span class="p">)</span>

        <span class="n">axes</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_axes</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">xlim</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_axes</span><span class="p">()</span>
            <span class="p">[</span><span class="n">axe</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span> <span class="k">for</span> <span class="n">axe</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">]</span>
            <span class="p">[</span><span class="n">axe</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">axe</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">impose_zero_start</span><span class="p">:</span>
            <span class="p">[</span><span class="n">axe</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">axe</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="p">[</span>
                <span class="n">axe</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">axe</span> <span class="ow">in</span> <span class="n">axes</span>
            <span class="p">]</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="LSForce.saverun"><a class="viewcode-back" href="../../api/lsforce.lsforce.html#lsforce.lsforce.LSForce.saverun">[docs]</a>    <span class="k">def</span> <span class="nf">saverun</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">,</span>
        <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">figs2save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">figs2save_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">light</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">filetype</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save a force inversion run for later use.</span>

<span class="sd">        Warning:</span>
<span class="sd">            Do not expect this to work if you have the ``autoreload``</span>
<span class="sd">            `IPython extension`_ enabled!</span>

<span class="sd">        Args:</span>
<span class="sd">            prefix (str): Run name to prepend to all output files</span>
<span class="sd">            filepath (str): Full path to directory where all files should be saved. If</span>
<span class="sd">                `None`, will use `self.main_folder`</span>
<span class="sd">            timestamp (bool): Name results with current time to avoid overwriting</span>
<span class="sd">                previous results</span>
<span class="sd">            figs2save (list or tuple): Figure handles to save</span>
<span class="sd">            figs2save_names (list or tuple): Names of figures (appends to end)</span>
<span class="sd">            light (bool): If `True`, does not save seismic data with object to save size</span>
<span class="sd">            filetype (str): Filetype given as extension, e.g. `&#39;png&#39;`</span>

<span class="sd">        .. _IPython extension: https://ipython.readthedocs.io/en/stable/config/extensions/autoreload.html</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_folder</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">light</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">st</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Get file name prefix</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">jk</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">jk</span> <span class="o">=</span> <span class="s1">&#39;JK&#39;</span>

        <span class="k">if</span> <span class="n">timestamp</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{:1.0f}</span><span class="s1">-</span><span class="si">{:1.0f}</span><span class="s1">sec_</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">prefix</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">[</span><span class="s1">&#39;periodmin&#39;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">[</span><span class="s1">&#39;periodmax&#39;</span><span class="p">],</span>
                <span class="n">jk</span><span class="p">,</span>
                <span class="n">UTCDateTime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H%M&#39;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{:1.0f}</span><span class="s1">-</span><span class="si">{:1.0f}</span><span class="s1">sec_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">prefix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">[</span><span class="s1">&#39;periodmin&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">[</span><span class="s1">&#39;periodmax&#39;</span><span class="p">],</span> <span class="n">jk</span>
            <span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">.pickle&#39;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">figs2save</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">figs2save_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">figs2save_names</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">figs2save</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fig</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">figs2save</span><span class="p">):</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">filepath</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">figs2save_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">filetype</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">),</span>
                    <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="LSForce.write_forces"><a class="viewcode-back" href="../../api/lsforce.lsforce.html#lsforce.lsforce.LSForce.write_forces">[docs]</a>    <span class="k">def</span> <span class="nf">write_forces</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">,</span>
        <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save E, N, Z forces to a text file for non-*lsforce* users.</span>

<span class="sd">        File can be read in using, e.g., NumPy as follows:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            import numpy as np</span>
<span class="sd">            e, n, z = np.loadtxt(&#39;/path/to/file.txt&#39;, unpack=True)</span>

<span class="sd">        Args:</span>
<span class="sd">            prefix (str): Run name to prepend to file</span>
<span class="sd">            filepath (str): Full path to directory where file should be saved.</span>
<span class="sd">                If `None`, will use `self.main_folder`</span>
<span class="sd">            timestamp (bool): Name file with current time to avoid overwriting</span>
<span class="sd">                previous results</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_folder</span>

        <span class="c1"># Format filename</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">UTCDateTime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{:1.0f}</span><span class="s1">-</span><span class="si">{:1.0f}</span><span class="s1">sec</span><span class="si">{}{}</span><span class="s1">.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">prefix</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">[</span><span class="s1">&#39;periodmin&#39;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">[</span><span class="s1">&#39;periodmax&#39;</span><span class="p">],</span>
            <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jackknife</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;_JK&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">current_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H%M&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">timestamp</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">st_proc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_time</span><span class="p">:</span>
            <span class="n">t0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_time</span>

        <span class="c1"># Form informative header</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;lsforce (https://code.usgs.gov/ghsc/lhp/lsforce) output forces</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;--------------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;FORCE SAMPLING RATE: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">force_sampling_rate</span><span class="si">}</span><span class="s1"> Hz</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;FORCE START TIME: </span><span class="si">{</span><span class="n">t0</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1"> UTC</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;FORCE UNITS: newtons</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;--------------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;FILE CREATED: </span><span class="si">{</span><span class="n">current_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1"> UTC</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;FILE COLUMNS: east north up</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;--------------------------------------------------------------&#39;</span>
        <span class="p">)</span>

        <span class="c1"># Save</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1"> saved to </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="find_alpha"><a class="viewcode-back" href="../../api/lsforce.lsforce.html#lsforce.lsforce.find_alpha">[docs]</a><span class="k">def</span> <span class="nf">find_alpha</span><span class="p">(</span>
    <span class="n">Ghat</span><span class="p">,</span>
    <span class="n">dhat</span><span class="p">,</span>
    <span class="n">I</span><span class="p">,</span>
    <span class="n">L1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">L2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">tikhonov_ratios</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
    <span class="n">rough</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">range_rough</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">int_rough</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
    <span class="n">plot_Lcurve</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Finds best regularization (trade-off) parameter alpha.</span>

<span class="sd">    Computes model with many values of alpha, plots L-curve, and finds point</span>
<span class="sd">    of steepest curvature where slope is negative.</span>

<span class="sd">    Args:</span>
<span class="sd">        Ghat (array): (m x n) matrix</span>
<span class="sd">        dhat (array): (1 x n) array of weighted data</span>
<span class="sd">        I (array): Identity matrix</span>
<span class="sd">        L1 (array): First order roughening matrix. If `0`, will use only</span>
<span class="sd">            0th-order Tikhonov regularization</span>
<span class="sd">        L2 (array): Second order roughening matrix. If `0`, will use only</span>
<span class="sd">            0th-order Tikhonov regularization</span>
<span class="sd">        tikhonov_ratios (list or tuple): Proportion each regularization method</span>
<span class="sd">            contributes to the overall regularization effect, where values</span>
<span class="sd">            correspond to [0th order, 1st order, 2nd order]. Must sum to 1</span>
<span class="sd">        rough (bool): If `False`, will do two iterations to fine tune the alpha</span>
<span class="sd">            parameter. The second iteration searches over +/- one order of</span>
<span class="sd">            magnitude from the best alpha found from the first round. If</span>
<span class="sd">            `True`, time will be saved because it will only do one round of</span>
<span class="sd">            searching.</span>
<span class="sd">        range_rough (tuple): Lower and upper bound of range to search over in</span>
<span class="sd">            log units. If `None`, the program will choose a range based on the</span>
<span class="sd">            norm of ``Ghat``</span>
<span class="sd">        int_rough (float): Interval, in log units, to use for rough alpha search</span>
<span class="sd">        plot_Lcurve (bool): Toggle showing the L-curve plot</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: Tuple containing:</span>

<span class="sd">        - **bestalpha** (float) – The optimal alpha</span>
<span class="sd">        - **fit1** (1D array) – List of residuals</span>
<span class="sd">        - **size1** (1D array) – List of model norms</span>
<span class="sd">        - **alphas** (1D array) – List of alphas tried</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Roughly estimate largest singular value (should not use alpha larger than expected</span>
    <span class="c1"># largest singular value)</span>
    <span class="n">templ1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Ghat</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">range_rough</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">templ2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">templ1</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="n">templ1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">int_rough</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">templ2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">range_rough</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">range_rough</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">int_rough</span><span class="p">)</span>
    <span class="n">alphas</span> <span class="o">=</span> <span class="mf">10.0</span><span class="o">**</span><span class="n">templ2</span>
    <span class="n">fit1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">size1</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">Apart</span> <span class="o">=</span> <span class="n">Ghat</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Ghat</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">L2</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">L2</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">L2part</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">L2part</span> <span class="o">=</span> <span class="n">L2</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">L2</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">L1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">L1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">L1part</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">L1part</span> <span class="o">=</span> <span class="n">L1</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">L1</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">Ghat</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">dhat</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rough</span><span class="p">:</span>
        <span class="n">maxloops</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">maxloops</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">loop</span> <span class="o">&lt;=</span> <span class="n">maxloops</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">alphas</span><span class="p">:</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">Apart</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">tikhonov_ratios</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">I</span>
                <span class="o">+</span> <span class="n">tikhonov_ratios</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">L1part</span>
                <span class="o">+</span> <span class="n">tikhonov_ratios</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">L2part</span>
            <span class="p">)</span>  <span class="c1"># Combo of all regularization things</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

            <span class="n">temp1</span> <span class="o">=</span> <span class="n">Ghat</span> <span class="o">@</span> <span class="n">model</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">dhat</span>
            <span class="n">fit1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">temp1</span><span class="p">))</span>
            <span class="n">size1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">tikhonov_ratios</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">model</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">tikhonov_ratios</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">L1part</span><span class="p">,</span> <span class="n">model</span><span class="p">))</span>
                <span class="o">+</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">tikhonov_ratios</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">L2part</span><span class="p">,</span> <span class="n">model</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="n">fit1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fit1</span><span class="p">)</span>
        <span class="n">size1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">size1</span><span class="p">)</span>

        <span class="n">curves</span> <span class="o">=</span> <span class="n">_curvature</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">fit1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">size1</span><span class="p">))</span>
        <span class="c1"># Zero out any points where function is concave to avoid picking points from</span>
        <span class="c1"># drop-off at end</span>
        <span class="n">slp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">size1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">fit1</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">fit1</span><span class="p">))</span>
        <span class="n">alphas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">alphas</span><span class="p">)</span>
        <span class="n">tempcurve</span> <span class="o">=</span> <span class="n">curves</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">tempcurve</span><span class="p">[</span><span class="n">slp2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">tempcurve</span><span class="p">)</span>
        <span class="n">bestalpha</span> <span class="o">=</span> <span class="n">alphas</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">loop</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">loop</span> <span class="o">&gt;</span> <span class="n">maxloops</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Loop again over smaller range</span>
            <span class="n">alphas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">bestalpha</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">bestalpha</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="mi">10</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">fit1</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">size1</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">plot_Lcurve</span><span class="p">:</span>
        <span class="n">Lcurve</span><span class="p">(</span><span class="n">fit1</span><span class="p">,</span> <span class="n">size1</span><span class="p">,</span> <span class="n">alphas</span><span class="p">,</span> <span class="n">bestalpha</span><span class="o">=</span><span class="n">bestalpha</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">bestalpha</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bestalpha</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Returned more than one alpha value, check codes.&#39;</span><span class="p">)</span>
        <span class="n">bestalpha</span> <span class="o">=</span> <span class="n">bestalpha</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">bestalpha</span><span class="p">,</span> <span class="n">fit1</span><span class="p">,</span> <span class="n">size1</span><span class="p">,</span> <span class="n">alphas</span></div>


<div class="viewcode-block" id="Lcurve"><a class="viewcode-back" href="../../api/lsforce.lsforce.html#lsforce.lsforce.Lcurve">[docs]</a><span class="k">def</span> <span class="nf">Lcurve</span><span class="p">(</span><span class="n">fit1</span><span class="p">,</span> <span class="n">size1</span><span class="p">,</span> <span class="n">alphas</span><span class="p">,</span> <span class="n">bestalpha</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Plot an L-curve.</span>

<span class="sd">    Args:</span>
<span class="sd">        fit1 (1D array): List of residuals</span>
<span class="sd">        size1 (1D array): List of model norms</span>
<span class="sd">        alphas (1D array): List of alphas tried</span>
<span class="sd">        bestalpha (float): The alpha value chosen</span>

<span class="sd">    Returns:</span>
<span class="sd">        figure handle</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">fit1</span><span class="p">,</span> <span class="n">size1</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">alphas</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">fit1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">size1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="sa">f</span><span class="s1">&#39;  </span><span class="si">{</span><span class="n">alpha</span><span class="si">:</span><span class="s1">.1e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bestalpha</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">alphas</span> <span class="o">-</span> <span class="n">bestalpha</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fit1</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">size1</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="s1">&#39;or&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Residual norm $||{\bfG}{\bfm}-{\bfd}||^2$&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Solution norm $||{\bfm}||^2$&#39;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span></div>


<span class="k">def</span> <span class="nf">_varred</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">dtnew</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Compute variance reduction :math:`\mathrm{VR}`.</span>

<span class="sd">    The formula is</span>

<span class="sd">    .. math::</span>

<span class="sd">        \mathrm{VR} = \left(1 - \frac{\|\mathbf{d}</span>
<span class="sd">        - \mathbf{d}_\mathbf{obs}\|^2}{\|\mathbf{d}_\mathbf{obs}\|^2}\right)</span>
<span class="sd">        \times 100\%\,,</span>

<span class="sd">    where :math:`\mathbf{d}_\mathbf{obs}` are the observed data, `dt`, and</span>
<span class="sd">    :math:`\mathbf{d}` are the synthetic data predicted by the forward model, `dtnew`.</span>

<span class="sd">    Args:</span>
<span class="sd">        dt: Array of original data</span>
<span class="sd">        dtnew: Array of modeled data</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: Variance reduction :math:`\mathrm{VR}`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">shp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
    <span class="n">shp</span> <span class="o">=</span> <span class="n">shp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">shp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dt_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">shp</span><span class="p">)</span>
    <span class="n">dtnew_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dtnew</span><span class="p">,</span> <span class="n">shp</span><span class="p">)</span>
    <span class="n">d_dnew2</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_temp</span> <span class="o">-</span> <span class="n">dtnew_temp</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="n">dt_temp</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">VR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">d_dnew2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">d2</span><span class="p">)))</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="k">return</span> <span class="n">VR</span>


<span class="k">def</span> <span class="nf">_makeconvmat</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Build matrix used for convolution as implemented by matrix multiplication.</span>

<span class="sd">    Args:</span>
<span class="sd">        c (1D array): Signal to make convolution matrix for</span>
<span class="sd">        size (list or tuple): Optional input for desired size as ``(nrows, ncols)``;</span>
<span class="sd">            this will just shift ``cflip`` until it reaches the right size</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`~numpy.ndarray`: Convolution matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cflip</span> <span class="o">=</span> <span class="n">c</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Flip order</span>
    <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">zros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">zros</span><span class="p">,</span> <span class="n">cflip</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">))))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(((</span><span class="n">cflip</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">))))</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Make it the correct size</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">zros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">zros</span><span class="p">,</span> <span class="n">cflip</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(((</span><span class="n">cflip</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>  <span class="c1"># Cut p to the correct size</span>
            <span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">C</span>


<span class="k">def</span> <span class="nf">_makeshiftmat</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">shiftby</span><span class="p">,</span> <span class="n">size1</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Build matrix that can be used for shifting of overlapping triangles.</span>

<span class="sd">    Used for triangle method. Signal goes across rows and each shift is a new column</span>
<span class="sd">    (opposite orientation to :func:`_makeconvmat`)</span>

<span class="sd">    Args:</span>
<span class="sd">        c: Array of data (usually Green&#39;s function)</span>
<span class="sd">        shiftby (int): Number of samples to shift Green&#39;s function in each row</span>
<span class="sd">        size1 (list or tuple): Shape ``(nrows, ncols)`` of desired result. Will pad `c`</span>
<span class="sd">            if ``nrows`` is greater than ``len(c)``. Will shift `c` forward `shiftby`</span>
<span class="sd">            :math:`\times` ``ncols`` times</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`~numpy.ndarray`: Matrix of shifted `c` of size `size1`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">diff</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">-</span> <span class="n">size1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">cpad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">diff</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">cpad</span> <span class="o">=</span> <span class="n">c</span><span class="p">[:</span> <span class="n">size1</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cpad</span> <span class="o">=</span> <span class="n">c</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size1</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># Loop over shifts and apply</span>
        <span class="n">nshift</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">shiftby</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">cpad</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="p">(</span><span class="n">nshift</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span><span class="p">)</span>  <span class="c1"># , end_values=(0., 0.))</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[:</span> <span class="n">size1</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">C</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">C</span>


<span class="k">def</span> <span class="nf">_curvature</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Estimate radius of curvature for each point on line to find corner of L-curve.</span>

<span class="sd">    Args:</span>
<span class="sd">        x: Array of x data</span>
<span class="sd">        y: Array of y data</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`~numpy.ndarray`: Radius of curvature for each point (ends will be NaN)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># For each set of three points, find the radius of the circle that fits them (ignore</span>
    <span class="c1"># ends - these should be infinity since it&#39;s a straight line that fits them)</span>
    <span class="n">R_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">R_2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">xsub</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">ysub</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
        <span class="c1"># Slope of bisector of first segment</span>
        <span class="n">m1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="p">((</span><span class="n">ysub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ysub</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">xsub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xsub</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="c1"># Slope of bisector of second segment</span>
        <span class="n">m2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="p">((</span><span class="n">ysub</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ysub</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">xsub</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xsub</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="c1"># Compute b for first bisector</span>
        <span class="n">b1</span> <span class="o">=</span> <span class="p">((</span><span class="n">ysub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ysub</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">m1</span> <span class="o">*</span> <span class="p">((</span><span class="n">xsub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">xsub</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Compute b for second bisector</span>
        <span class="n">b2</span> <span class="o">=</span> <span class="p">((</span><span class="n">ysub</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ysub</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">m2</span> <span class="o">*</span> <span class="p">((</span><span class="n">xsub</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">xsub</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">Xc</span> <span class="o">=</span> <span class="p">(</span><span class="n">b1</span> <span class="o">-</span> <span class="n">b2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m2</span> <span class="o">-</span> <span class="n">m1</span><span class="p">)</span>  <span class="c1"># Find intercept point of bisectors</span>
        <span class="n">Yc</span> <span class="o">=</span> <span class="n">b2</span> <span class="o">+</span> <span class="n">m2</span> <span class="o">*</span> <span class="n">Xc</span>

        <span class="c1"># Get distance from any point to intercept of bisectors to get radius</span>
        <span class="n">R_2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xsub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">Xc</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">ysub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">Yc</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">R_2</span>


<span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Wrapper for :func:`obspy.core.stream.read` for long URLs.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_band_code</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Determine SEED band code for a given sampling interval.</span>

<span class="sd">    SEED band code reference:</span>
<span class="sd">    http://www.fdsn.org/pdf/SEEDManual_V2.4_Appendix-A.pdf (see page 2)</span>

<span class="sd">    Code copied from Instaseis:</span>
<span class="sd">    https://github.com/krischer/instaseis/blob/dc9d4f16e55837236712e3dde2fbe10902393940/instaseis/helpers.py#L45-L61</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dt</span> <span class="o">&lt;=</span> <span class="mf">0.001</span><span class="p">:</span>
        <span class="n">band_code</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span>
    <span class="k">elif</span> <span class="n">dt</span> <span class="o">&lt;=</span> <span class="mf">0.004</span><span class="p">:</span>
        <span class="n">band_code</span> <span class="o">=</span> <span class="s1">&#39;C&#39;</span>
    <span class="k">elif</span> <span class="n">dt</span> <span class="o">&lt;=</span> <span class="mf">0.0125</span><span class="p">:</span>
        <span class="n">band_code</span> <span class="o">=</span> <span class="s1">&#39;H&#39;</span>
    <span class="k">elif</span> <span class="n">dt</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">:</span>
        <span class="n">band_code</span> <span class="o">=</span> <span class="s1">&#39;B&#39;</span>
    <span class="k">elif</span> <span class="n">dt</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">band_code</span> <span class="o">=</span> <span class="s1">&#39;M&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">band_code</span> <span class="o">=</span> <span class="s1">&#39;L&#39;</span>
    <span class="k">return</span> <span class="n">band_code</span>


<div class="viewcode-block" id="readrun"><a class="viewcode-back" href="../../api/lsforce.lsforce.html#lsforce.lsforce.readrun">[docs]</a><span class="k">def</span> <span class="nf">readrun</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Read in a saved LSForce object.</span>

<span class="sd">    Warning:</span>
<span class="sd">        Do not expect this to work if you have the ``autoreload``</span>
<span class="sd">        `IPython extension`_ enabled!</span>

<span class="sd">    Args:</span>
<span class="sd">        filename (str): File path to LSForce object saved using</span>
<span class="sd">            :meth:`~lsforce.lsforce.LSForce.saverun`</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`~lsforce.lsforce.LSForce`: Saved LSForce object</span>

<span class="sd">    .. _IPython extension: https://ipython.readthedocs.io/en/stable/config/extensions/autoreload.html</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Kate E. Allstadt and Liam Toney.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>